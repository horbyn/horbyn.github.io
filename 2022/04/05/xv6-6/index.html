<!DOCTYPE html>
<html lang="en">
    <!-- title -->
<!-- keywords -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Horbyn">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Horbyn">
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    <meta name="description" content="">
    <meta name="description" content="本次 lab 对应三个 moderate 难度的任务，关系线程调度、如何加锁等原理">
<meta property="og:type" content="article">
<meta property="og:title" content="⌈xv6-fall2021⌋ lab 6：Multithreading">
<meta property="og:url" content="https://horbyn.github.io/2022/04/05/xv6-6/">
<meta property="og:site_name">
<meta property="og:description" content="本次 lab 对应三个 moderate 难度的任务，关系线程调度、如何加锁等原理">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-04-05T13:55:42.000Z">
<meta property="article:modified_time" content="2025-02-27T14:24:07.033Z">
<meta property="article:author" content="Horbyn">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/avatar/link.PNG">
    <title>⌈xv6-fall2021⌋ lab 6：Multithreading · HorbynzZ</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .footer-fixed-btn,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link id="stylesheet-fancybox" rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-base" rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-mobile" rel="preload" href="/css/mobile.css" as="style" onload="this.onload=null;this.rel='stylesheet';this.media='screen and (max-width: 960px)'">
    <link id="stylesheet-theme-dark" rel="preload" href="/css/dark.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    <!-- 百度统计  -->
    <!-- 谷歌统计  -->
    <!-- Google tag (gtag.js) -->
<meta name="generator" content="Hexo 6.0.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div class="header-sidebar-menu">
            <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/">Horbynz hub</a>
        </span>
    </div>
    <!-- toggle banner -->
    <div class="banner">
        <div class="blog-title header-element">
            <a href="/">Horbynz hub</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">⌈xv6-fall2021⌋ lab 6：Multithreading</a>
        </div>
    </div>
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.png)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                ⌈xv6-fall2021⌋ lab 6：Multithreading
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <a class="post-tag" href="javascript:void(0);" data-tags="xv6">xv6</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">4.3k</span>Reading time: <span class="post-count reading-time">19 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2022/04/05</span>
                    <!-- busuanzi -->
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h2 id="lab">LAB</h2>
<p>传送门：<a
target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/thread.html">Lab:
Multithreading</a></p>
<p><br></p>
<h2 id="intro">INTRO</h2>
<p>读 <a
target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf">xv6-handout-fall
2021, chapter 7</a> 有感，以下是 xv6 线程（进程）切换过程</p>
<p>如何标识一个线程？</p>
<ul>
<li>PC</li>
<li>寄存器环境（上下文）</li>
<li>线程的栈</li>
</ul>
<p>xv6 如何组织线程？如图所示：</p>
<p><img
src="https://pic.imgdb.cn/item/624be6fd239250f7c547ef17.jpg" /></p>
<ul>
<li>每个用户进程都有其对应的内核线程。相当于每个用户进程都有两个线程，第一个位于用户空间，有独立的地址；第二个位于内核空间，使用共享的内存地址</li>
<li>所谓对应的内核线程，其实并没有具体的代码文件。我的理解是
trampoline()、usertrap()、usertropret() 这些和 trap
相关的函数（线程切换这个故事也是开始于陷入 trap
！），只不过不同线程执行速度不一样，即上下文不一样，所以才属于不同的线程</li>
</ul>
<p>一个线程切换的例子，从 CC 命令切换到 LS 命令：</p>
<p><img
src="https://pic.imgdb.cn/item/624bed84239250f7c554c190.jpg" /></p>
<ol type="1">
<li>从 CC 用户线程陷入 CC 内核线程（CC<sub>k</sub>），陷入过程中在
trampoline() 内将用户线程上下文保存到 trapframe</li>
<li>CC<sub>k</sub> 要让出 CPU，进入 swtch() 上半场的处理。先保护
CC<sub>k</sub> 现场，存入 context 对象（context
结构体总是保存了内核线程在执行 swtch() 时的状态；而 trapframe
栈帧总是保存了用户线程在执行 trampoline() 时的状态）</li>
<li>swtch() 恢复当前 CPU 调度器的上下文和栈，之后用这个环境执行
scheduler()</li>
<li>scheduler() 先将 CC<sub>k</sub> 状态改为
RUNNABLE，然后在进程表中找到 LS<sub>k</sub>，最后又调用
swtch()（只不过此时的 swtch() 不是刚才进入的那个）</li>
<li>进入 swtch() 下半场：
<ul>
<li>先将调度器的上下文和栈保存到自己的 context 对象</li>
<li>再将 LS<sub>k</sub> 的 context 对象恢复，即加载为当前 CPU
寄存器组，从而恢复上次被打断的 swtch()</li>
</ul></li>
<li>返回到 LS<sub>k</sub> 的 trampoline，恢复 trapframe</li>
<li>恢复 LS 用户线程</li>
</ol>
<p>值得注意的是，这里的两个 swtch() 调用实际不是同一个。进入调度器的是
sched() 的 swtch()；而调度器返回的却是 scheduler() 的
swtch()。上述例子对应的程序流如下：</p>
<ol type="1">
<li>陷入：trampoline() -&gt; usertrap() -&gt; devintr()</li>
<li>让出 CPU：-&gt; yield() -&gt; sched()</li>
<li>保护现场并切换至调度器：-&gt; swtch()</li>
<li>调度器进行调度：-&gt; scheduler()</li>
<li>另一个线程登场：-&gt; swtch()</li>
</ol>
<p>xv6 总共包含三种类型的上下文信息：</p>
<ol type="1">
<li>用户上下文：由 trapframe 结构体保存</li>
<li>内核上下文：由 context 结构体保存</li>
<li>调度器上下文：由 cpu 结构体保存（cpu 结构体包含 context
成员，所以最终也是保存在 context
对象上。只不过区分不同的调度器线程是依据 cpu 是否相同，只有 cpu
寄存器环境才标识一个调度器）</li>
</ol>
<p><br></p>
<h2 id="uthread-switching-between-threads-moderate">Uthread: switching
between threads (MODERATE)</h2>
<h3 id="要求">要求</h3>
<blockquote>
<p>In this exercise you will design the context switch mechanism for a
user-level threading system, and then implement it.</p>
</blockquote>
<p>"在这个练习中，你将为一个用户级线程系统设计上下文切换机制，并且实现"</p>
<blockquote>
<p>The threading package is missing some of the code to create a thread
and to switch between threads.</p>
</blockquote>
<p>"线程库缺乏一些创建线程和在不同线程间切换的代码"</p>
<blockquote>
<p>Your job is to come up with a plan to create threads and save/restore
registers to switch between threads, and implement that plan. When
you're done, make grade should say that your solution passes the uthread
test.</p>
</blockquote>
<p>"你的工作是想出一个策略，用以创建线程、在线程切换间保存和恢复现场，并且实现。当你完成后，<code>make grade</code>
会提示你的解决方案通过了 uthread test"</p>
<blockquote>
<p>One goal is ensure that when thread_schedule() runs a given thread
for the first time, the thread executes the function passed to
thread_create(), on its own stack. Another goal is to ensure that
thread_switch saves the registers of the thread being switched away
from, restores the registers of the thread being switched to, and
returns to the point in the latter thread's instructions where it last
left off.</p>
</blockquote>
<p>"第一个目标是确保在 thread_schedule()
第一次运行时，可以在自己的栈上执行 thread_create()
传递的参数。第二个目标是确保 thread_switch()
保存了将要切换走的线程的寄存器组，同时恢复将要切换过去的线程的寄存器组，最后返回到后一个线程上次停止的地方"</p>
<blockquote>
<p>You'll need to add a call to thread_switch in thread_schedule; you
can pass whatever arguments you need to thread_switch, but the intent is
to switch from thread t to next_thread.</p>
</blockquote>
<p>"你需要在 thread_schedule() 中调用
thread_switch()；传递任何你需要的参数给
thread_switch，只要保证能够从线程 t 切换至 next_thread"</p>
<p><br></p>
<h3 id="提示">提示</h3>
<p>这次提示很简单，就是切换过程中只需要保存 callee 的上下文，并且阅读
<code>user/uthread.asm</code> 对 debugging 非常有参考意义</p>
<p><br></p>
<h3 id="summary">Summary</h3>
<p>主要参考 xv6 线程调度的程序流就行，对比这里，试想当前场景是从线程 t
切换为 next_thread，那么：</p>
<ul>
<li>核心任务是保存线程 t 的上下文，然后恢复 next_thread
的上下文，最后返回地址改为 next_thread 上次中断处</li>
<li>首先要保存的上下文只有 callee 负责的那些寄存器，这和
<code>kernel/proc.h</code> 的 context 结构体是一样的</li>
<li>然后考虑保存在哪？既然文件给了 thread
结构体，那自然是新增一个上下文字段更方便</li>
</ul>
<p>这里面还有个小细节要注意：</p>
<ul>
<li>每个线程在执行时都需要自己的栈，但栈是往低处长的（grow
downwards），所以保存栈地址应该是高地址</li>
</ul>
<p><br></p>
<h3 id="solution">Solution</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// path: user/uthread.c</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">context</span> &#123;</span><br><span class="line">  uint64 ra;</span><br><span class="line">  uint64 sp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// callee-saved</span></span><br><span class="line">  uint64 s0;</span><br><span class="line">  uint64 s1;</span><br><span class="line">  uint64 s2;</span><br><span class="line">  uint64 s3;</span><br><span class="line">  uint64 s4;</span><br><span class="line">  uint64 s5;</span><br><span class="line">  uint64 s6;</span><br><span class="line">  uint64 s7;</span><br><span class="line">  uint64 s8;</span><br><span class="line">  uint64 s9;</span><br><span class="line">  uint64 s10;</span><br><span class="line">  uint64 s11;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">thread</span> &#123;</span><br><span class="line">  <span class="type">char</span>       stack[STACK_SIZE]; <span class="comment">/* the thread&#x27;s stack */</span></span><br><span class="line">  <span class="type">int</span>        state;             <span class="comment">/* FREE, RUNNING, RUNNABLE */</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">context</span> cont;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">thread_schedule</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (current_thread != next_thread) &#123;         <span class="comment">/* switch threads?  */</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">/* YOUR CODE HERE</span></span><br><span class="line"><span class="comment">         * Invoke thread_switch to switch from t to next_thread:</span></span><br><span class="line"><span class="comment">         * thread_switch(??, ??);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">thread_switch</span>((uint64)&amp;t-&gt;cont, (uint64)&amp;next_thread-&gt;cont);</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        next_thread = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">thread_create</span><span class="params">(<span class="type">void</span> (*func)())</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// YOUR CODE HERE</span></span><br><span class="line">    t-&gt;cont.ra = (uint64)func;</span><br><span class="line">    t-&gt;cont.sp = (uint64)&amp;t-&gt;stack[STACK_SIZE - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">	.text</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">     * save the old thread&#x27;s registers,</span><br><span class="line">     * restore the new thread&#x27;s registers.</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">	.globl thread_switch</span><br><span class="line">thread_switch:</span><br><span class="line">	/* YOUR CODE HERE */</span><br><span class="line">	sd ra, 0(a0)</span><br><span class="line">	sd sp, 8(a0)</span><br><span class="line">	sd s0, 16(a0)</span><br><span class="line">	sd s1, 24(a0)</span><br><span class="line">	sd s2, 32(a0)</span><br><span class="line">	sd s3, 40(a0)</span><br><span class="line">	sd s4, 48(a0)</span><br><span class="line">	sd s5, 56(a0)</span><br><span class="line">	sd s6, 64(a0)</span><br><span class="line">	sd s7, 72(a0)</span><br><span class="line">	sd s8, 80(a0)</span><br><span class="line">	sd s9, 88(a0)</span><br><span class="line">	sd s10, 96(a0)</span><br><span class="line">	sd s11, 104(a0)</span><br><span class="line"></span><br><span class="line">	ld ra, 0(a1)</span><br><span class="line">	ld sp, 8(a1)</span><br><span class="line">	ld s0, 16(a1)</span><br><span class="line">	ld s1, 24(a1)</span><br><span class="line">	ld s2, 32(a1)</span><br><span class="line">	ld s3, 40(a1)</span><br><span class="line">	ld s4, 48(a1)</span><br><span class="line">	ld s5, 56(a1)</span><br><span class="line">	ld s6, 64(a1)</span><br><span class="line">	ld s7, 72(a1)</span><br><span class="line">	ld s8, 80(a1)</span><br><span class="line">	ld s9, 88(a1)</span><br><span class="line">	ld s10, 96(a1)</span><br><span class="line">	ld s11, 104(a1)</span><br><span class="line"></span><br><span class="line">	ret    /* return to ra */</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="using-threads-moderate">Using threads (MODERATE)</h2>
<h3 id="要求-1">要求</h3>
<blockquote>
<p>The file notxv6/ph.c contains a simple hash table that is correct if
used from a single thread, but incorrect when used from multiple
threads. In your main xv6 directory (perhaps ~/xv6-labs-2021), type
this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$ </span><span class="language-bash">make ph</span></span><br><span class="line"><span class="meta">$ </span><span class="language-bash">./ph 1</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>"文件 <code>notxv6/ph.c</code>
包含一个简单的哈希表，如果用在单线程上是正确的，但使用多线程却不正确。在你的
xv6 主目录下（可能如 <code>~/xv6-labs-2021</code>），输入上面命令"</p>
<blockquote>
<p>The argument to ph specifies the number of threads that execute put
and get operations on the the hash table. After running for a little
while, ph 1 will produce output similar to this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">100000 puts, 3.991 seconds, 25056 puts/second</span><br><span class="line">0: 0 keys missing</span><br><span class="line">100000 gets, 3.981 seconds, 25118 gets/second</span><br></pre></td></tr></table></figure>
</blockquote>
<p>"ph 的参数指出在哈希表上执行 put 和 get
操作的线程数量。运行一段时间后，<code>ph 1</code>
会产生上面那样的输出"</p>
<blockquote>
<p>ph runs two benchmarks. First it adds lots of keys to the hash table
by calling put(), and prints the achieved rate in puts per second. The
it fetches keys from the hash table with get(). It prints the number
keys that should have been in the hash table as a result of the puts but
are missing (zero in this case), and it prints the number of gets per
second it achieved.</p>
</blockquote>
<p>"ph 运行两种基准。第一种是通过 put() 往哈希表里增加大量的
key，并且每秒都会打印在 put() 里增加 key 的配置速度；第二种是通过 get()
从哈希表里取出 key。ph 还会打印因 put() 本应在哈希表中存在，实际却丢失的
key 的数量（在上面例子中是 0），并且也会打印 get() 的每秒配置速度"</p>
<blockquote>
<p>You can tell ph to use its hash table from multiple threads at the
same time by giving it an argument greater than one. Try ph 2:
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$ </span><span class="language-bash">./ph 2</span></span><br><span class="line">100000 puts, 1.885 seconds, 53044 puts/second</span><br><span class="line">1: 16579 keys missing</span><br><span class="line">0: 16579 keys missing</span><br><span class="line">200000 gets, 4.322 seconds, 46274 gets/second</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>"你可以传入一个大于 1 的参数，让 ph 使用多线程操作哈希表。输入
<code>ph 2</code> 如上面所示"</p>
<blockquote>
<p>The first line of this ph 2 output indicates that when two threads
concurrently add entries to the hash table, they achieve a total rate of
53,044 inserts per second. That's about twice the rate of the single
thread from running ph 1.</p>
</blockquote>
<p>"<code>ph 2</code>
输出的第一行，指出并发执行两个线程向哈希表增加条目时，插入总速率达到
53044 项每秒。这大概是 <code>ph 1</code> 运行单线程的两倍"</p>
<blockquote>
<p>However, the two lines saying 16579 keys missing indicate that a
large number of keys that should have been in the hash table are not
there. That is, the puts were supposed to add those keys to the hash
table, but something went wrong. Have a look at notxv6/ph.c,
particularly at put() and insert().</p>
</blockquote>
<p>"然而，（接下来的）丢失 16579 个 key 这两行指出有大量 key
本应在哈希表内但实际却丢失了。即 put() 将这些 key
加入了哈希表，但发生了一些错误。阅读 <code>notxv6/ph.c</code> 特别是
put() 和 insert()"</p>
<blockquote>
<p>Why are there missing keys with 2 threads, but not with 1 thread?
Identify a sequence of events with 2 threads that can lead to a key
being missing. Submit your sequence with a short explanation in
answers-thread.txt</p>
</blockquote>
<p>"为什么用 2 个线程会丢失 key？而 1 个线程不会？想想导致 key 丢失的 2
个线程的事件发生次序，在 answers-thread.txt 写下简要的解释并提交"</p>
<blockquote>
<p>Modify your code so that some put operations run in parallel while
maintaining correctness. You're done when make grade says your code
passes both the ph_safe and ph_fast tests. The ph_fast test requires
that two threads yield at least 1.25 times as many puts/second as one
thread.</p>
</blockquote>
<p>"修改你的代码以便 put 操作在正确的前提下能并行运行，当
<code>make grade</code> 提示你的代码均通过 ph_safe 和 ph_fast
两个测试时才算完成。其中 ph_fast 测试要求两个线程运行速度至少是单个 put
线程的 1.25 倍"</p>
<p><br></p>
<h3 id="summary-1">Summary</h3>
<p>首先阅读 main()，可以发现逻辑大约如此：</p>
<ul>
<li>创建 put 操作线程</li>
<li>put 线程主要调用 put() 和 insert() 两个函数</li>
<li>put() 遍历 table[]，找出和形参 key
相同的一项。之后判断这一项元素是否存在，若存在直接覆盖原值，否则调用
insert() 头插法链入链表</li>
<li>get 操作不会对并行操作造成影响所以不考虑</li>
</ul>
<p>然后要考虑的一个问题是，为什么多线程场景会出问题？既然是链表，所以可以参考
<a
target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf">xv6-handout-fall
2021, section 6.1</a> 这个链表双线程的并发执行例子，大概如此：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[thread 0] 在 put() 中发现是新结点，正准备调用 insert()</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 1] 在 put() 也发现是新结点，也准备调用 insert()</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 0] 调用 insert() 结束后，在原本结点 i 这个地方新增了一个 &#123;key, value&#125; 键值对的结点</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 1] 已经通过了 if(e) 的条件判断，走入了 else() 分支，但实际上 thread 0 已经改变了条件的情况，</span><br><span class="line">            此时 thread 1 理应走 if() 分支。可惜，thread 1 不知道情况仍在相同地址上调用 insert() ，</span><br><span class="line">            最终覆盖了 thread 0 刚才新增的键值对，从而丢失 key</span><br></pre></td></tr></table></figure>
<p>一句话总结就是，共享的数据没有锁保护所以出问题了。这里 table[]
就是共享数据，多个线程都对这块数据写入，那么先写入的数据必然被覆盖（丢失）</p>
<p>所以最简单的想法就是在写入操作，也即是 insert()
头插法执行前后加锁，但如果这么加锁是有问题的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误的</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">insert</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value, <span class="keyword">struct</span> entry **p, <span class="keyword">struct</span> entry *n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;lock);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">entry</span> *e = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> entry));</span><br><span class="line">    e-&gt;key = key;</span><br><span class="line">    e-&gt;value = value;</span><br><span class="line">    e-&gt;next = n;</span><br><span class="line">    *p = e;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理由如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[thread 0] 当前索引匹配 table[0]，并检查到不存在结点，所以进入了 insert()，正准备执行</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 1] 在 put() 循环中也找到 table[0]，也检测到结点不存在，正准备调用 insert()</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 0] 调用 insert() 结束后，在原本结点 i 这个地方新增了一个 &#123;key, value&#125; 键值对的结点</span><br><span class="line">-------- schedule() ----------</span><br><span class="line">[thread 1] 调用 insert() 最终覆盖了 thread 0 新追加的结点</span><br></pre></td></tr></table></figure>
<p>所以锁的请求应该往回调用，放在循环结束后而判断前比较合适</p>
<p><br></p>
<h3 id="solution-1">Solution</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// notxv6/ph.c</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> lock;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">insert</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value, <span class="keyword">struct</span> entry **p, <span class="keyword">struct</span> entry *n)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    *p = e;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (e = table[i]; e != <span class="number">0</span>; e = e-&gt;next) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// lab multithreading</span></span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;lock);</span><br><span class="line">    <span class="keyword">if</span>(e) &#123;</span><br><span class="line">        <span class="comment">// update the existing key.</span></span><br><span class="line">        e-&gt;value = value;</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;lock);</span><br><span class="line">    &#125; <span class="keyword">else</span> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="built_in">main</span>(<span class="type">int</span> argc, <span class="type">char</span> *argv[]) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NKEYS; i++) &#123;</span><br><span class="line">        keys[i] = <span class="built_in">random</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lab multithreading</span></span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;lock, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// first the puts</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    t0 = <span class="built_in">now</span>();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="barrier-moderate">Barrier (MODERATE)</h2>
<h3 id="要求-2">要求</h3>
<blockquote>
<p>In this assignment you'll implement a barrier: a point in an
application at which all participating threads must wait until all other
participating threads reach that point too. You'll use pthread condition
variables, which are a sequence coordination technique similar to xv6's
sleep and wakeup.</p>
</blockquote>
<p>"在这个任务中，你将要实现一个
barrier：是一个指针，作用是使得所有参与执行的线程必须等，直到其他线程全部到达
barrier 这个指针的地址处才能继续执行。你还需要使用 pthread
条件变量，这是和 xv6 的 sleep() 和 wakeup() 差不多的时序配合机制"</p>
<blockquote>
<p>The file notxv6/barrier.c contains a broken barrier.
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$ </span><span class="language-bash">make barrier</span></span><br><span class="line"><span class="meta">$ </span><span class="language-bash">./barrier 2</span></span><br><span class="line">barrier: notxv6/barrier.c:42: thread: Assertion `i == t&#x27; failed.</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>"文件 <code>notxv6/barrier.c</code> 包含了一个未完成的 barrier
程序，像上面那样"</p>
<blockquote>
<p>The 2 specifies the number of threads that synchronize on the barrier
( nthread in barrier.c). Each thread executes a loop. In each loop
iteration a thread calls barrier() and then sleeps for a random number
of microseconds. The assert triggers, because one thread leaves the
barrier before the other thread has reached the barrier. The desired
behavior is that each thread blocks in barrier() until all nthreads of
them have called barrier().</p>
</blockquote>
<p>"参数 2 指定在 barrier()（在 barrier.c 里面的
nthread）程序中同步的线程数量。每个线程执行一个循环。每个循环的一次迭代中，线程调用
barrier() 然后沉睡一个随机微秒。assert 命中是因为一个线程在其他线程到达
barrier() 之前离开了。一个可采取的策略是每个线程阻塞在 barrier()
直到所有这些线程的都调用了 barrier()"</p>
<blockquote>
<p>You have to deal with a succession of barrier calls, each of which
we'll call a round. bstate.round records the current round. You should
increment bstate.round each time all threads have reached the
barrier.</p>
</blockquote>
<p>"你需要解决如何将一个线程的调用组织成一个连续的循环，每个循环称为一个
'round'。<code>bstate.round</code> 记录了当前的
round。你需要在所有线程到达 barrier() 时自增
<code>bstate.round</code>"</p>
<p>———— 这里的循环我是这么理解的：一个线程进入 for() 之后会撞上
barrier，然后停住。这之后一段时间其他线程会发生很多事，但对于我们这个线程来说都无视，直到它被某种条件唤醒，退出
barrier 后又回到 for() 新一次迭代。这便是一个循环，即一个 round</p>
<blockquote>
<p>You have to handle the case in which one thread races around the loop
before the others have exited the barrier. In particular, you are
re-using the bstate.nthread variable from one round to the next. Make
sure that a thread that leaves the barrier and races around the loop
doesn't increase bstate.nthread while a previous round is still using
it.</p>
</blockquote>
<p>"你必须处理其他线程退出 barrier()
之前，某一个线程在循环中产生的竞争情况。特别需要注意的是，程序流正在从这一轮到下一轮中重复使用
<code>bstate.nthread</code> 变量的情况。确保离开 barrier()
并在循环中出现竞争情况的一个线程在前一个循环仍然使用
<code>bstate.nthread</code> 变量的时候，不要自增这个变量"</p>
<p>———— 这里的竞争情况我理解为 lost wakeup：即线程 0
正检查条件以进入沉睡（此时可能外界看起来状态为
SLEEPING，但实际还未完全切换过去），却发生了调度。后来其他线程唤醒了线程
0。之后调度又回到线程 0，但是线程 0
先执行的仍然是进入沉睡的检查，最终丢失了唤醒信号从而死锁</p>
<p>————
回到这个场景里，前半句说的竞争情况，应该是让我们注意不要丢失线程在
barrier() 的 lost wakeup；后半句说的重复使用
<code>bstate.nthread</code>，应该是让我们注意到这是一个共享数据，第二个线程访问的时候，就算
re-using，这需要通过锁来保护</p>
<p><br></p>
<h3 id="summary-2">Summary</h3>
<p>现在总结以下思路：</p>
<ul>
<li>根据题意，核心思想是每个线程都需要撞上
barrier，即停在这里。什么时候可以重新继续？答案是所有线程到达的时候。所以
barrier() 里面的逻辑最直接的想法是：当前撞上 barrier
的线程数量未够，就在 condition variables 上挂起；直到所有线程到达</li>
<li>访问 <code>bstate.nthread</code>
需要加锁，理由是上面说的这是一个共享数据</li>
<li>同时需要在 condition variables 释放时，变量 round
自增，同时当前循环的线程数归零</li>
</ul>
<p><br></p>
<h3 id="solution-2">Solution</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// path: notxv6/barrier.c</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">barrier</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// YOUR CODE HERE</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Block until all threads have called barrier() and</span></span><br><span class="line">    <span class="comment">// then increment bstate.round.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;bstate.barrier_mutex);</span><br><span class="line">    ++bstate.nthread;</span><br><span class="line">    <span class="keyword">if</span> (bstate.nthread != nthread) &#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;bstate.barrier_cond, &amp;bstate.barrier_mutex);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bstate.round++;</span><br><span class="line">        bstate.nthread = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">pthread_cond_broadcast</span>(&amp;bstate.barrier_cond);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;bstate.barrier_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<h2 id="写在最后">写在最后</h2>
<p>耗时 11h25m</p>

    </article>
    <!-- license -->
        <div class="license-wrapper">
            <p>Author：<a href="https://horbyn.github.io">Horbyn</a>
            <p>Link：<a href="https://horbyn.github.io/2022/04/05/xv6-6/">https://horbyn.github.io/2022/04/05/xv6-6/</a>
            <p>Publish date：<a href="https://horbyn.github.io/2022/04/05/xv6-6/">April 5th 2022, 9:55:42 pm</a>
            <p>Update date：<a href="https://horbyn.github.io/2022/04/05/xv6-6/">February 27th 2025, 10:24:07 pm</a>
            <p>License：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
                <div class="nextSlogan">Next Post</div>
                <a href="/2022/04/11/xv6-7/" title="⌈xv6-fall2021⌋ lab 7：networking">
                    <div class="nextTitle">⌈xv6-fall2021⌋ lab 7：networking</div>
                </a>
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/2022/04/04/xv6-5/" title="⌈xv6-fall2021⌋ lab 5：COW">
                    <div class="prevTitle">⌈xv6-fall2021⌋ lab 5：COW</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="mailto:horbyn@outlook.com" class="iconfont-archer email" title="email" ></a>
                <a href="https://github.com/horbyn" class="iconfont-archer github" target="_blank" title="github"></a>
                <span class="iconfont-archer wechat" title="wechat">
                    <img class="profile-qr" src="/assets/example_qr.jpg" />
                </span>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    <!-- 不蒜子  -->
        <div class="busuanzi-container">
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#lab"><span class="toc-number">1.</span> <span class="toc-text">LAB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intro"><span class="toc-number">2.</span> <span class="toc-text">INTRO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uthread-switching-between-threads-moderate"><span class="toc-number">3.</span> <span class="toc-text">Uthread: switching
between threads (MODERATE)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E6%B1%82"><span class="toc-number">3.1.</span> <span class="toc-text">要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA"><span class="toc-number">3.2.</span> <span class="toc-text">提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#summary"><span class="toc-number">3.3.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#solution"><span class="toc-number">3.4.</span> <span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-threads-moderate"><span class="toc-number">4.</span> <span class="toc-text">Using threads (MODERATE)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E6%B1%82-1"><span class="toc-number">4.1.</span> <span class="toc-text">要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#summary-1"><span class="toc-number">4.2.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-1"><span class="toc-number">4.3.</span> <span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#barrier-moderate"><span class="toc-number">5.</span> <span class="toc-text">Barrier (MODERATE)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E6%B1%82-2"><span class="toc-number">5.1.</span> <span class="toc-text">要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#summary-2"><span class="toc-number">5.2.</span> <span class="toc-text">Summary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#solution-2"><span class="toc-number">5.3.</span> <span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">写在最后</span></a></li></ol>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 24
        </div>
        <!-- search  -->
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">02/10</span>
            <a class="archive-post-title" href="/2025/02/10/hoo-8/">「从零到一」内置命令</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/07</span>
            <a class="archive-post-title" href="/2025/02/07/hoo-7/">「从零到一」文件系统</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2025/02/05/hoo-6/">「从零到一」设备驱动</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/04</span>
            <a class="archive-post-title" href="/2025/02/04/hoo-5/">「从零到一」调度机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/01</span>
            <a class="archive-post-title" href="/2025/02/01/hoo-4/">「从零到一」中断机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span>
            <a class="archive-post-title" href="/2025/01/30/hoo-3/">「从零到一」内存管理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/07</span>
            <a class="archive-post-title" href="/2025/01/07/hoo-2/">「从零到一」内核引导与加载</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/02</span>
            <a class="archive-post-title" href="/2025/01/02/hoo-1/">「从零到一」实现一个 x86 的内核</a>
        </li>
                </ul>
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2023/11/01/live-1/">ARM 模拟 x86 环境不能直接使用 gdb 调试的解决方案</a>
        </li>
                </ul>
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/2022/05/28/trans-2/">x86 AT&T 汇编快速入门（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-11/">⌈xv6-fall2021⌋ MIT 6.828 巡礼</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-10/">⌈xv6-fall2021⌋ lab 10：mmap</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span>
            <a class="archive-post-title" href="/2022/04/17/xv6-9/">⌈xv6-fall2021⌋ lab 9：file system</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2022/04/15/xv6-8/">⌈xv6-fall2021⌋ lab 8：locks</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2022/04/11/xv6-7/">⌈xv6-fall2021⌋ lab 7：networking</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/2022/04/05/xv6-6/">⌈xv6-fall2021⌋ lab 6：Multithreading</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span>
            <a class="archive-post-title" href="/2022/04/04/xv6-5/">⌈xv6-fall2021⌋ lab 5：COW</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/trans-1/">RISC-V 调用约定（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/xv6-4/">⌈xv6-fall2021⌋ lab 4：Traps</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/25</span>
            <a class="archive-post-title" href="/2022/03/25/xv6-3/">⌈xv6-fall2021⌋ lab 3：Page tables</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2022/03/16/xv6-2/">⌈xv6-fall2021⌋ lab 2：System calls</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/14</span>
            <a class="archive-post-title" href="/2022/03/14/winsock/">Winsock 实现一个端到端通信软件</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2022/02/28/xv6-1/">⌈xv6-fall2021⌋ lab 1：Xv6 and Unix utilities</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span>
            <a class="archive-post-title" href="/2022/02/25/xv6-0/">⌈xv6-fall2021⌋ MIT 6.828 环境配置</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="hoo">
                <span class="iconfont-archer">&#xe606;</span>
                hoo
            </span>
            <span class="sidebar-tag-name" data-tags="translation">
                <span class="iconfont-archer">&#xe606;</span>
                translation
            </span>
            <span class="sidebar-tag-name" data-tags="winsock">
                <span class="iconfont-archer">&#xe606;</span>
                winsock
            </span>
            <span class="sidebar-tag-name" data-tags="xv6">
                <span class="iconfont-archer">&#xe606;</span>
                xv6
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
        <span class="sidebar-category-name" data-categories="KERNEL">
            <span class="iconfont-archer">&#xe60a;</span>
            KERNEL
        </span>
        <span class="sidebar-category-name" data-categories="LIVEHOOD">
            <span class="iconfont-archer">&#xe60a;</span>
            LIVEHOOD
        </span>
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://horbyn.github.io",
        root: siteMetaRoot,
        author: "Horbyn"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- main func -->
        <script src="/scripts/main.js"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js" onload="window.Fancybox.bind('[data-fancybox]')" defer></script>
        <!-- algolia -->
        <!-- busuanzi -->
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        <!-- async load share.js -->
            <script src="/scripts/share.js" async></script>
        <!-- mermaid -->
    </body>
</html>
