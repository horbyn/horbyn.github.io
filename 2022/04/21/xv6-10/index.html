<!DOCTYPE html>
<html lang="en">
    <!-- title -->
<!-- keywords -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Horbyn">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Horbyn">
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    <meta name="description" content="">
    <meta name="description" content="结合虚拟内存和文件系统操作，实现内存映射文件（memory-mapped file）逻辑，难度比较大。内存映射文件本身不属于内核基础功能，和写时拷贝、小锁优化一样，属于扩展功能">
<meta property="og:type" content="article">
<meta property="og:title" content="⌈xv6-fall2021⌋ lab 10：mmap">
<meta property="og:url" content="https://horbyn.github.io/2022/04/21/xv6-10/">
<meta property="og:site_name">
<meta property="og:description" content="结合虚拟内存和文件系统操作，实现内存映射文件（memory-mapped file）逻辑，难度比较大。内存映射文件本身不属于内核基础功能，和写时拷贝、小锁优化一样，属于扩展功能">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-04-21T06:02:33.000Z">
<meta property="article:modified_time" content="2025-02-28T15:27:31.343Z">
<meta property="article:author" content="Horbyn">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/avatar/link.PNG">
    <title>⌈xv6-fall2021⌋ lab 10：mmap · HorbynzZ</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .footer-fixed-btn,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link id="stylesheet-fancybox" rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-base" rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-mobile" rel="preload" href="/css/mobile.css" as="style" onload="this.onload=null;this.rel='stylesheet';this.media='screen and (max-width: 960px)'">
    <link id="stylesheet-theme-dark" rel="preload" href="/css/dark.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    <!-- 百度统计  -->
    <!-- 谷歌统计  -->
    <!-- Google tag (gtag.js) -->
<meta name="generator" content="Hexo 6.0.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div class="header-sidebar-menu">
            <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/">Horbynz hub</a>
        </span>
    </div>
    <!-- toggle banner -->
    <div class="banner">
        <div class="blog-title header-element">
            <a href="/">Horbynz hub</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">⌈xv6-fall2021⌋ lab 10：mmap</a>
        </div>
    </div>
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.png)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                ⌈xv6-fall2021⌋ lab 10：mmap
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <a class="post-tag" href="javascript:void(0);" data-tags="xv6">xv6</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">5.9k</span>Reading time: <span class="post-count reading-time">25 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2022/04/21</span>
                    <!-- busuanzi -->
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h2 id="about">ABOUT</h2>
<p>实验地址：<a
target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/mmap.html">Lab:
mmap</a></p>
<p><br></p>
<h2 id="mmap-hard">Mmap (HARD)</h2>
<h3 id="实验要求译节选">实验要求（译）（节选）</h3>
<blockquote>
<p>mmap can be called in many ways, but this lab requires only a subset
of its features relevant to memory-mapping a file. You can assume that
addr will always be zero, meaning that the kernel should decide the
virtual address at which to map the file. mmap returns that address, or
0xffffffffffffffff if it fails. length is the number of bytes to map; it
might not be the same as the file's length. prot indicates whether the
memory should be mapped readable, writeable, and/or executable; you can
assume that prot is PROT_READ or PROT_WRITE or both. flags will be
either MAP_SHARED, meaning that modifications to the mapped memory
should be written back to the file, or MAP_PRIVATE, meaning that they
should not. You don't have to implement any other bits in flags. fd is
the open file descriptor of the file to map. You can assume offset is
zero (it's the starting point in the file at which to map).</p>
</blockquote>
<p>"mmap 可以用在许多方面，但本次 lab
只涉及关于内存映射文件的部分。你可以假设 addr 总是
0，即由内核决定将文件映射去哪里。mmap
调用成功时返回这个映射地址，或者调用失败返回 0xffffffffffffffff。length
要映射的字节数，可能和文件本身的长度不同。 prot
指出被映射的内存是否可读、可写、可执行，可以假定要么可读，要么可写，要么可读可写。flags
要么是 MAP_SHARED，意味着被映射内存的修改要写回文件；要么是
MAP_PRIVATE，意味着不用写回，这个参数不用考虑其他标志位的实现。fd
是要映射的文件打开时的文件描述符。你可以假定 offset 是
0，偏移指出映射文件从哪里开始访问"</p>
<blockquote>
<p>munmap(addr, length) should remove mmap mappings in the indicated
address range. If the process has modified the memory and has it mapped
MAP_SHARED, the modifications should first be written to the file. An
munmap call might cover only a portion of an mmap-ed region, but you can
assume that it will either unmap at the start, or at the end, or the
whole region (but not punch a hole in the middle of a region).</p>
</blockquote>
<p>"<code>munmap(addr, length)</code> 要移除指定地址范围处
<code>mmap()</code> 设置的映射。如果进程已经修改了内存，并且标志位为
MAP_SHARED，那么这次修改应该首先写回文件。一个 <code>munmap()</code>
调用可能只作用于已映射的那部分区域，所以你可以假定取消映射要么开始于该区域开头处，要么开始于该区域结尾处，要么是整个趋于（而不会是区域中间某个部分）"</p>
<p><br></p>
<h3 id="实验提示译节选">实验提示（译）（节选）</h3>
<blockquote>
<p>Fill in the page table lazily, in response to page faults. That is,
mmap should not allocate physical memory or read the file. Instead, do
that in page fault handling code in (or called by) usertrap, as in the
lazy page allocation lab. The reason to be lazy is to ensure that mmap
of a large file is fast, and that mmap of a file larger than physical
memory is possible.</p>
</blockquote>
<p>"页表分配推迟到相应 page-fault 时才进行，即 <code>mmap()</code>
不应该分配物理内存或者读文件。相反，在 <code>usertrap()</code> 的
page-fault 中断例程时才作出实际分配，就像 lazy page allocation lab
那样。因为这样做可以确保 <code>mmap()</code>
能迅速分配大文件，也可以分配一个比物理内存更大的文件"</p>
<blockquote>
<p>Keep track of what mmap has mapped for each process. Define a
structure corresponding to the VMA (virtual memory area) described in
Lecture 15, recording the address, length, permissions, file, etc. for a
virtual memory range created by mmap. Since the xv6 kernel doesn't have
a memory allocator in the kernel, it's OK to declare a fixed-size array
of VMAs and allocate from that array as needed. A size of 16 should be
sufficient.</p>
</blockquote>
<p>"保持追踪 <code>mmap()</code> 为每个进程映射了什么。定义一个 LEC-15
指出的 VMA 对应的结构体，为 <code>mmap()</code> 创建的 VMA
结构记录地址、长度、权限、待映射的文件等等。因为 xv6
内核没有内存分配器，所以声明一个固定大小的 VMA
数组，并在需要时才使用是没问题的。大小固定为 16 就足够了"</p>
<blockquote>
<p>Implement mmap: find an unused region in the process's address space
in which to map the file, and add a VMA to the process's table of mapped
regions. The VMA should contain a pointer to a struct file for the file
being mapped; mmap should increase the file's reference count so that
the structure doesn't disappear when the file is closed (hint: see
filedup). Run mmaptest: the first mmap should succeed, but the first
access to the mmap-ed memory will cause a page fault and kill
mmaptest.</p>
</blockquote>
<p>"实现
<code>mmap()</code>：为待映射的文件在进程地址空间找一段不使用的区域，然后将此区域添加到进程的映射区域内。VMA
结构应该包含一个指向 <code>struct file</code>
的指针，指向待映射的文件，并为映射文件增加一次引用，以便文件关闭时该结构不会消失（参考
<code>filedup()</code>）。运行 <code>mmaptest</code>：第一个 mmap
测试点会成功，但第一次访问已映射区域会抛出 page-fault，然后内核会杀死
<code>mmaptest</code>"</p>
<blockquote>
<p>Add code to cause a page-fault in a mmap-ed region to allocate a page
of physical memory, read 4096 bytes of the relevant file into that page,
and map it into the user address space. Read the file with readi, which
takes an offset argument at which to read in the file (but you will have
to lock/unlock the inode passed to readi). Don't forget to set the
permissions correctly on the page. Run mmaptest; it should get to the
first munmap.</p>
</blockquote>
<p>"对于已映射区域的 page-fault，遇到才分配内存，将相关文件的 4096
字节读入页（即分配一页），并将这一页映射到用户地址空间。此时调用
<code>readi()</code> 读取文件，<code>readi()</code>
需要待读文件上的偏移作为参数（但上不上锁传入 <code>readi()</code> 的
indoe 都可以）。同时也不要忘记分配这一页权限。此时运行
<code>mmaptest</code> 应该可以到达第一个 <code>munmap</code>"</p>
<blockquote>
<p>Implement munmap: find the VMA for the address range and unmap the
specified pages (hint: use uvmunmap). If munmap removes all pages of a
previous mmap, it should decrement the reference count of the
corresponding struct file. If an unmapped page has been modified and the
file is mapped MAP_SHARED, write the page back to the file. Look at
filewrite for inspiration.</p>
</blockquote>
<p>"实现 <code>munmap()</code>：找到给定地址范围的 VMA，然后使用
<code>uvmunmap()</code> 取消指定的多个页的映射。如果
<code>munmap()</code> 移除了前面调用的 <code>mmap()</code>
的所有页，那就一并减去相应文件 <code>struct file</code>
结构体的引用计数。已修改且标为 MAP_SHARED 的页要先写回文件（参考
<code>filewrite()</code>）"</p>
<blockquote>
<p>Ideally your implementation would only write back MAP_SHARED pages
that the program actually modified. The dirty bit (D) in the RISC-V PTE
indicates whether a page has been written. However, mmaptest does not
check that non-dirty pages are not written back; thus you can get away
with writing pages back without looking at D bits.</p>
</blockquote>
<p>"理论上只需写回实际修改过的 MAP_SHARED 页，这些页通过 PTE 里的脏位（D
位）指出该页是否已写入。不过 <code>mmaptest</code>
不检查非脏页是否没有被写回，因此你无需检查 D 位就可以写回"</p>
<blockquote>
<p>Modify exit to unmap the process's mapped regions as if munmap had
been called. Run mmaptest; mmap_test should pass, but probably not
fork_test.</p>
</blockquote>
<p>"<code>exit()</code> 要取消进程的已映射区域的所有页的映射，像
<code>munmap()</code> 那样。此时运行 <code>mmaptest</code>，mmap_test
测试点可以通过，但可能 fork_test 不能通过"</p>
<blockquote>
<p>Modify fork to ensure that the child has the same mapped regions as
the parent. Don't forget to increment the reference count for a VMA's
struct file. In the page fault handler of the child, it is OK to
allocate a new physical page instead of sharing a page with the parent.
The latter would be cooler, but it would require more implementation
work. Run mmaptest; it should pass both mmap_test and fork_test.</p>
</blockquote>
<p>"修改 <code>fork()</code>
使子进程拥有与父进程一样的映射区域。但不要忘了增加 VMA 的
<code>struct file</code> 结构体的引用计数。子进程的 page-fault
时期，可以分配新物理页而不是共享父进程的页。共享页可能很高效率，但也需要更复杂的实现。此时运行
<code>mmaptest</code> 才能通过 fork_test 测试点"</p>
<p><br></p>
<h3 id="实现思路">实现思路</h3>
<p>首先要知道 <code>mmap()</code> 是什么，但是 mmap
只是一个功能，需要作用在一个称为 <strong>内存映射文件（memory-mapped
file）</strong>
的数据结构上，其核心思想是应用将文件映射到自己的地址空间，此时使用 mmap
这种技术就可以达到
<strong>访问用户进程自己的地址空间相当于访问文件</strong></p>
<p>但是，其实上（就我个人理解来说）mmap 技术读写小文件和常规
<code>read()</code> / <code>write()</code> 逻辑是一样的，见下图：</p>
<p><img
src="https://pic.imgdb.cn/item/62611602239250f7c50df59c.jpg" /></p>
<p>如图所示是 <em>常规 <code>read()</code> / <code>write()</code>
读写文件</em>，程序读写文件需要经过两次拷贝，第一次是从磁盘到 block
cache；第二次是从 block cache 到用户空间</p>
<p><img
src="https://pic.imgdb.cn/item/62611602239250f7c50df595.jpg" /></p>
<p>上图所示是我理解的 <em>mmap
技术读写文件</em>，可以发现逻辑上也是经过了两次拷贝，同常规技术一样，都是先拷贝到内核的
block cache，然后再拷贝到用户进程可访问的缓冲区</p>
<p>我个人认为，这里的开销是差不多的，起码 xv6 源码看起来是这样（如 xv6
执行 <code>read()</code> 系统调用，先陷入内核态，然后由对应的
<code>sys_read()</code> 调用 <code>fileread()</code>，再调用
<code>readi()</code> 完成读文件操作。这里最后的 <code>readi()</code>
最终完成了将磁盘文件读入内存 inode，然后再从内存 inode
将数据拷贝至用户空间），所以 <strong>绝不是网上那种一致的说法，说使用了
mmap 技术可以省去最后拷贝回用户进程这步的开销</strong>（当然，POSIX
接口比如 Linux 的 <code>mmap()</code>
是怎样实现的，我不了解，可能就因为这样疏忽了更加关键的细节也说不定，所以这里涉及的开销问题的讨论仅供参考）</p>
<p>其实无论用户态还是内核态，本质都是内存的某一片区域，拷贝开销都是一样的
———— 如果我在某一个内核函数里定义了一个缓冲区，那么从 block cache
到这个缓冲区（内核缓冲区到内核缓冲区）；以及从 block cache
到上图所示的用户进程
buffer（内核缓冲区到用户缓冲区），这两者开销是一样的。都是将数据从内存某处拷贝到某处，开销还能不一样吗？但区别还是有的，只是访问权限不同而已</p>
<p>现在我们再来想想使用 mmap 技术有什么不同。可能你会觉得是不是常规的
<code>read()</code> / <code>write()</code>
是系统调用，所以多了一步保护现场的开销？但你别忘了我们这个 lab 实现的
mmap 也是要封装成系统调用的形式</p>
<p>那还有什么地方不同？或者更优的地方在哪？我个人理解是，mmap
技术最大的不同是按需分配，可以回顾下实验开头的这段话：</p>
<blockquote>
<p>The mmap and munmap system calls allow UNIX programs to exert
detailed control over their address spaces. They can be used to share
memory among processes, to map files into process address spaces, and as
part of user-level page fault schemes such as the garbage-collection
algorithms discussed in lecture.</p>
</blockquote>
<p>这段话指出，mmap 这种技术可以用在：</p>
<ul>
<li>进程间共享内存：常规的 <code>read()</code> / <code>write()</code>
如果是多个进程访问同一个文件，那么内存会同时存在两份副本，这就造成更大的内存开销</li>
<li>将文件映射至进程地址空间：这个和常规读写是一样的，常规读写虽然谈不上映射，但逻辑上访问它自己的缓冲区也是相当于在访问文件</li>
<li>用于
page-fault：这是我觉得和常规读写最大的区别。读写小文件无论哪种技术，由于核心逻辑都要经过两次拷贝，所以开销都是差不多的。但是读写大文件，你内存只有
16GB，我想访问 80G 的大文件，常规读写根本做不到；但是引入
page-fault（回顾前面的 lab cow）这就成为可能</li>
</ul>
<p><br></p>
<p>现在需要考虑的是 VMA 这个数据结构，我先把上面 mmap
技术这幅图拿下来</p>
<p><img
src="https://pic.imgdb.cn/item/62611602239250f7c50df595.jpg" /></p>
<p>图上紫箭头 ① ② 两步访问的这个 vma 区域就是和 mmap
技术相关的一个数据结构，你可以把这个数据结构定义在内核数据区（如在进程结构体
PCB
上新增一个字段），那么这个数据结构至少需要记录一些虚拟地址，用户进程通过这些虚拟地址访问实际的、存储着文件数据的
mmap-ed 区域（后文均统称为 "已映射区域"）</p>
<p>上图 ③ ⑥
两个箭头的读写可能会产生一些误解。它们访问的是缺页时分配的页（实际的物理地址），但实际上，用户进程不可能直接访问物理地址，这里其实是先访问
vma
结构记录的虚拟地址，通过页表机制的翻译最终访问到物理内存上，但我此处画图直接画到物理内存上了</p>
<p>至于 vma 数据结构应该包含什么内容，你可以参考 POSIX
接口。但我这里只定义实验要求和实验提示给出的内容：</p>
<ul>
<li>该 vma 区域对应的虚拟地址起址</li>
<li>映射文件的长度</li>
<li>权限（读写）</li>
<li>是否写回</li>
<li>文件描述符</li>
<li>文件偏移</li>
<li>待映射的文件的指针</li>
</ul>
<p><br></p>
<p>现在考虑另一个问题，那就是 vma
结构所需的虚拟地址应该如何分配？你总不可能从 0
开始分配吧，又或是随便用一个虚拟地址。这里使用的虚拟地址必须是进程没有被使用的，但是实际上，xv6
内核可没有管理虚拟地址分配的能力。<code>kalloc()</code>
分配的是物理地址，管理着用户进程的物理页的分配</p>
<p>所以这就需要我们对 xv6 的内存分布非常熟悉：</p>
<p><img
src="https://pic.imgdb.cn/item/6261232a239250f7c52d3d5c.png" /></p>
<p>如图所示是进程的地址空间，对于一个进程来说，我们只能使用堆区。虽然我不清楚
xv6 有没有实现堆内存分配、堆分配是怎样的。但我直觉上认为如果 xv6
有这个实现，也是从堆底开始，所以这里我管理的 vma
结构使用的虚拟内存是从堆顶开始的，如图所示：</p>
<p><img
src="https://pic.imgdb.cn/item/62612447239250f7c52fb95e.jpg" /></p>
<p>那么，考虑 vma 分配逻辑，我们可以定义一个初始的指针，指向的地址刚好是
MAXVA 减去两个页面的大小，那么我们每次分配一个 vma
区域，思想和入栈一样，向低地址增长，像上图右半部分一样，vma
指针需要减去用户请求的映射长度。可以发现，vma
分配是非常简单的，只要指针无脑减减减就行了</p>
<p>但是释放逻辑稍微有点复杂，考虑过程略去，我这里直接报上结论：根据取消映射全部的文件还是部分，而复杂情况不同。这里面判是否取消部分映射，取决于：</p>
<ul>
<li>vma 起址与 unmap 起址</li>
<li>vma 长度与 unmap 长度</li>
</ul>
<p>上面两点，两两搭配共有四种情况，分别是：</p>
<p><img
src="https://pic.imgdb.cn/item/6261283d239250f7c5388d63.jpg" /></p>
<ul>
<li>第一种情况：这是释放整个文件，此时 vma 区域直接释放掉</li>
<li>第二种情况：这是释放部分文件，此时 vma
区域不单单要修改起始虚拟地址，还要修改映射长度</li>
<li>第三种情况：不存在，因为不可能文件起始地址与释放地址不同，但释放长度是整个文件的长度，这会释放后一个
vma 的部分区域</li>
<li>第四种情况：这也是释放部分文件，但此时 vma 区域只需修改映射长度</li>
</ul>
<p>现在还需要考虑最后一个问题，既然 vma
的分配释放类似栈的思想（但实际上区别很大，此处 vma
可以随机访问任一个虚拟地址，但栈不能访问栈底、栈中间。这里说的只是 vma
指针的调整类似于栈），那么还需要考虑怎么让 vma 指针往上走回去的问题</p>
<p><img
src="https://pic.imgdb.cn/item/62612b3f239250f7c53fb697.jpg" /></p>
<p>上图 mmap 映射了两个文件，随后释放文件 2，此时 vma
指针可以往上调整吗？答案是不可以，因为文件 1
还未释放，此时往上调那么下次分配映射会覆盖了文件 1 的地址</p>
<p><img
src="https://pic.imgdb.cn/item/62612b3f239250f7c53fb69e.jpg" /></p>
<p>现在情况来到文件 1 的释放时，此时可以往上调整 vma
指针吗？答案是可以，因为往上的这两个区域都已经没有映射了</p>
<p>最后的最后，剩下 <code>fork()</code> 和 <code>exit()</code>
的改进。exit
没其他注意事项，逻辑上一个进程退出时，释放所有的映射文件就行，其实就是
<code>munmap()</code> 的逻辑；至于
fork，由于子进程是另外的进程，它也有自己独立的地址空间，所以直接将父进程的
vma
数组全部拷贝过去就行，不需要担心子进程拥有和父进程一样的页表映射，这里只拷贝
vma
数组并不会拷贝父进程的页表，所以实际上子进程是没有任何页表映射的，如果子进程访问到自己的
vma 数组，会抛出
page-fault，然后内核分配另外的物理页（虽然也是映射到同一个文件）。这个
lab 不要求子进程共享父进程的物理页，所以实际上简单很多。注意子进程 fork
后记得为映射文件自增引用计数，否则 <code>fork_test</code> 在
<code>fileclose()</code> 时肯定会出问题</p>
<p><br></p>
<h3 id="solution">Solution</h3>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># path: ./Makefile</span></span><br><span class="line">UPROGS=\</span><br><span class="line">    ...</span><br><span class="line">    $U/_mmaptest\</span><br></pre></td></tr></table></figure>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># path: user/usys.pl</span></span><br><span class="line">entry(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">entry(<span class="string">&quot;munmap&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// path: user/user.h</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">mmap</span><span class="params">(<span class="type">void</span> *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">munmap</span><span class="params">(<span class="type">void</span> *, uint)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/syscall.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_mmap   22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_munmap 23</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/syscall.c</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> uint64 <span class="title">sys_mmap</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> uint64 <span class="title">sys_munmap</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="title">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> </span>= &#123;</span><br><span class="line">...</span><br><span class="line">[SYS_mmap]    sys_mmap,</span><br><span class="line">[SYS_munmap]  sys_munmap,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/riscv.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_D (1L &lt;&lt; 7)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/defs.h</span></span><br><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"><span class="function"><span class="type">pte_t</span> *<span class="title">walk</span><span class="params">(<span class="type">pagetable_t</span>, uint64, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="comment">// sysfile.c</span></span><br><span class="line"><span class="function">uint64 <span class="title">pgfault</span><span class="params">(uint64)</span></span>;</span><br><span class="line"><span class="function">uint64 <span class="title">subunmap</span><span class="params">(uint64, <span class="type">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/proc.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXVMA 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">vma_t</span> &#123;</span><br><span class="line">    <span class="type">int</span> valid;<span class="comment">// 1 表示有效；0 表示无效即可使用</span></span><br><span class="line">    uint64 va;</span><br><span class="line">    uint len;</span><br><span class="line">    <span class="type">int</span>  prot;</span><br><span class="line">    <span class="type">int</span>  flags;</span><br><span class="line">    <span class="type">int</span>  fd;</span><br><span class="line">    <span class="type">long</span> off;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">file</span> *f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">proc</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">vma_t</span> vma[MAXVMA];</span><br><span class="line">    uint64 curend;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/sysfile.c</span></span><br><span class="line"><span class="comment">// mmap(虚拟地址, 映射长度, 权限, 写回, fd, 偏移)</span></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_mmap</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    uint64 va;</span><br><span class="line">    <span class="type">int</span> len, prot, flags, fd, off;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">argaddr</span>(<span class="number">0</span>, &amp;va) &lt; <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">argint</span>(<span class="number">1</span>, &amp;len) &lt; <span class="number">0</span> || <span class="built_in">argint</span>(<span class="number">2</span>, &amp;prot) &lt; <span class="number">0</span></span><br><span class="line">        || <span class="built_in">argint</span>(<span class="number">3</span>, &amp;flags) &lt; <span class="number">0</span> || <span class="built_in">argint</span>(<span class="number">4</span>, &amp;fd) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">argint</span>(<span class="number">5</span>, &amp;off) &lt; <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查参数</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p = <span class="built_in">myproc</span>();</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ofile[fd] == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">// fd 代表的打开文件不存在</span></span><br><span class="line">    <span class="keyword">else</span>    <span class="built_in">filedup</span>(p-&gt;ofile[fd]);<span class="comment">// 否则增加一次引用</span></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ofile[fd]-&gt;writable == <span class="number">0</span><span class="comment">// 不可写文件映射可写属性</span></span><br><span class="line">        &amp;&amp; (prot &amp; PROT_WRITE) == PROT_WRITE</span><br><span class="line">        &amp;&amp; (flags &amp; MAP_SHARED) == MAP_SHARED)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配 vma 结构体</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;vma[i].valid == <span class="number">0</span>) &#123;</span><br><span class="line">            p-&gt;vma[i].valid = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i == MAXVMA)    <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">// vma 数组没有空闲位置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填充 vma</span></span><br><span class="line">    p-&gt;vma[i].va = p-&gt;curend - len;<span class="comment">// 分配一个虚拟地址</span></span><br><span class="line">    p-&gt;curend = p-&gt;vma[i].va;<span class="comment">// 同时修正下一个虚拟地址</span></span><br><span class="line">    p-&gt;vma[i].len = len;</span><br><span class="line">    uint pteflags = <span class="number">0</span>;<span class="comment">// 以下几句赋值 PTE 权限</span></span><br><span class="line">    <span class="keyword">if</span> ((prot &amp; PROT_READ) == PROT_READ)    pteflags |= PTE_R;</span><br><span class="line">    <span class="keyword">if</span> ((prot &amp; PROT_WRITE) == PROT_WRITE)    pteflags |= PTE_W;</span><br><span class="line">    p-&gt;vma[i].prot = pteflags;</span><br><span class="line">    p-&gt;vma[i].flags = flags;</span><br><span class="line">    p-&gt;vma[i].fd = fd;</span><br><span class="line">    p-&gt;vma[i].off = off;</span><br><span class="line">    p-&gt;vma[i].f = p-&gt;ofile[fd];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (uint64)p-&gt;vma[i].va;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_munmap</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    uint64 va;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">argaddr</span>(<span class="number">0</span>, &amp;va) &lt; <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">argint</span>(<span class="number">1</span>, &amp;len) &lt; <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为 exit() 也要 unmap，所以主体逻辑封装为另一个函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">subunmap</span>(va, len) == <span class="number">-1</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为头文件问题</span></span><br><span class="line"><span class="comment">// usertrap() 处理逻辑要写在包含 file.h 的文件里</span></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">pgfault</span><span class="params">(uint64 va)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p = <span class="built_in">myproc</span>();</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">vma_t</span> *v = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 寻找出对应的 vma 元素</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;vma[i].valid == <span class="number">1</span> &amp;&amp; p-&gt;vma[i].va &lt;= va</span><br><span class="line">            &amp;&amp; va &lt;= p-&gt;vma[i].va + p-&gt;vma[i].len) &#123;</span><br><span class="line">            v = &amp;p-&gt;vma[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配一页</span></span><br><span class="line">    <span class="comment">// 安装映射</span></span><br><span class="line">    <span class="comment">// 将文件 4096B 写入（使用 readi()）</span></span><br><span class="line">    uint64 pa = (uint64)<span class="built_in">kalloc</span>();</span><br><span class="line">    <span class="keyword">if</span> (pa == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *)pa, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于等会 readi() 是从 inode 读数据，输出至用户地址 va</span></span><br><span class="line">    <span class="comment">// 所以要先建立用户地址 va 到物理地址 pa 的映射</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mappages</span>(p-&gt;pagetable, va, PGSIZE, pa, v-&gt;prot|PTE_U) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">kfree</span>((<span class="type">void</span> *)pa);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// inode 数据写入 va</span></span><br><span class="line">    <span class="built_in">ilock</span>(v-&gt;f-&gt;ip);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">readi</span>(v-&gt;f-&gt;ip, <span class="number">1</span>, va, v-&gt;off + va - v-&gt;va, PGSIZE);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">kfree</span>((<span class="type">void</span> *)pa);</span><br><span class="line">        <span class="built_in">iunlock</span>(v-&gt;f-&gt;ip);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">iunlock</span>(v-&gt;f-&gt;ip);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">subunmap</span><span class="params">(uint64 va, <span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p = <span class="built_in">myproc</span>();</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">vma_t</span> *v = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 寻找出对应的 vma 元素</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;vma[i].valid == <span class="number">1</span> &amp;&amp; p-&gt;vma[i].va &lt;= va</span><br><span class="line">            &amp;&amp; va &lt;= p-&gt;vma[i].va + p-&gt;vma[i].len) &#123;</span><br><span class="line">            v = &amp;p-&gt;vma[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查 va 对应的映射</span></span><br><span class="line">    va = <span class="built_in">PGROUNDDOWN</span>(va);</span><br><span class="line">    <span class="type">pte_t</span> *pte = <span class="built_in">walk</span>(p-&gt;pagetable, va, <span class="number">0</span>);<span class="comment">// 第一个取消页的 pte</span></span><br><span class="line">    <span class="keyword">if</span> (pte == <span class="number">0</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    uint64 pteflags = <span class="built_in">PTE_FLAGS</span>(*pte);<span class="comment">// 第一个取消页的 pte flags</span></span><br><span class="line">    uint64 pa;</span><br><span class="line">    <span class="keyword">if</span> ((pa = <span class="built_in">walkaddr</span>(p-&gt;pagetable, va)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 已安装映射，物理地址必存在，需要检查写回，再取消映射</span></span><br><span class="line">        <span class="comment">// 未安装映射，什么都不用做</span></span><br><span class="line">        <span class="keyword">if</span> (v-&gt;flags &amp; MAP_SHARED) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((pteflags &amp; PTE_D) == PTE_D) &#123;</span><br><span class="line">                <span class="type">int</span> ret = <span class="built_in">filewrite</span>(v-&gt;f, va, len);</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">-1</span>)    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取消映射</span></span><br><span class="line">        <span class="built_in">uvmunmap</span>(p-&gt;pagetable, va, len / PGSIZE, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依照文件是部分 unmap 还是全部 unmap，情况不同</span></span><br><span class="line">    <span class="comment">// 判断是否是部分 unmap，可对比</span></span><br><span class="line">    <span class="comment">//     1.  vma 起址是否等同本次 unmap 起址</span></span><br><span class="line">    <span class="comment">//     2.  vma 长度是否等同本次 unmap 长度</span></span><br><span class="line">    <span class="comment">// 上述情况两两组合共四种情况</span></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;va == va &amp;&amp; v-&gt;len == len) &#123;</span><br><span class="line">        <span class="comment">// vma 起址 == un 起址，且 vma 长度 == un 长度</span></span><br><span class="line">        <span class="comment">// 即完全 unmap 文件</span></span><br><span class="line">        v-&gt;len -= len;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v-&gt;va == va &amp;&amp; v-&gt;len != len) &#123;</span><br><span class="line">        <span class="comment">// vma 起址 == un 起址，且 vma 长度 != un 长度</span></span><br><span class="line">        <span class="comment">// 部分 unmap 文件，un 文件开头部分</span></span><br><span class="line">        v-&gt;va += len;</span><br><span class="line">        v-&gt;len -= len;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v-&gt;va != va &amp;&amp; v-&gt;len == len) &#123;</span><br><span class="line">        <span class="comment">// vma 起址 != un 起址，且 vma 长度 == un 长度</span></span><br><span class="line">        <span class="comment">// 这种情况不存在</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v-&gt;va != va &amp;&amp; v-&gt;len != len) &#123;</span><br><span class="line">        <span class="comment">// vma 起址 != un 起址，且 vma 长度 != un 长度</span></span><br><span class="line">        <span class="comment">// 部分 unmap 文件，un 文件后面部分</span></span><br><span class="line">        v-&gt;len -= len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v-&gt;len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果 unmap 整个文件</span></span><br><span class="line">        v-&gt;va = <span class="number">0</span>;</span><br><span class="line">        v-&gt;valid = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">fileclose</span>(v-&gt;f);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调整 curend</span></span><br><span class="line">        <span class="keyword">if</span> (va == p-&gt;curend) &#123;</span><br><span class="line">        <span class="comment">// 当最后一个文件 unmap</span></span><br><span class="line">        p-&gt;curend += len;</span><br><span class="line">        <span class="keyword">for</span> (uint64 unva = <span class="built_in">PGROUNDDOWN</span>(p-&gt;curend);</span><br><span class="line">                unva &lt; MAXVA - <span class="number">2</span> * PGSIZE; unva += PGSIZE) &#123;</span><br><span class="line">            <span class="comment">// 往上遍历每一个虚拟地址</span></span><br><span class="line">            <span class="type">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">            <span class="comment">// 判断是否在 vma 数组中存在</span></span><br><span class="line">            <span class="comment">// 不存在的话，curend 上调</span></span><br><span class="line">            <span class="keyword">if</span> (p-&gt;vma[i].va == unva &amp;&amp; p-&gt;vma[i].valid == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == MAXVMA)    p-&gt;curend += PGSIZE;<span class="comment">// 不存在</span></span><br><span class="line">            <span class="keyword">else</span>    <span class="keyword">break</span>;<span class="comment">// 只要上面的 vma 区域有一个没取消，就停止上调</span></span><br><span class="line">        &#125;<span class="comment">// end for()</span></span><br><span class="line">        &#125;<span class="comment">// end if()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/proc.c</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">proc</span>*</span><br><span class="line"><span class="built_in">allocproc</span>(<span class="type">void</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    p-&gt;curend = MAXVA - <span class="number">2</span> * PGSIZE;<span class="comment">// 堆最高端</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">fork</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 将父进程的 vma 数组全部拷贝过去</span></span><br><span class="line">    <span class="built_in">memmove</span>(np-&gt;vma, p-&gt;vma, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> <span class="type">vma_t</span>));</span><br><span class="line">    np-&gt;curend = p-&gt;curend;</span><br><span class="line">    <span class="comment">// 注意文件计数加 1</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (np-&gt;vma[i].valid == <span class="number">1</span>)</span><br><span class="line">            <span class="built_in">filedup</span>(np-&gt;vma[i].f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">exit</span><span class="params">(<span class="type">int</span> status)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(p == initproc)</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;init exiting&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAXVMA; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;vma[i].valid == <span class="number">1</span>)</span><br><span class="line">            <span class="built_in">subunmap</span>(p-&gt;vma[i].va, p-&gt;vma[i].len);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// path: kernel/trap.c</span></span><br><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrap</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = <span class="built_in">devintr</span>()) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// ok</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (which_dev == <span class="number">0</span> &amp;&amp; (uint64)<span class="built_in">r_scause</span>() == <span class="number">13</span>) &#123;</span><br><span class="line">        <span class="comment">// page-fault 时 scause 记录错误码；stval 记录无法翻译的 va</span></span><br><span class="line">        <span class="comment">// riscv 三种 page-fault</span></span><br><span class="line">        <span class="comment">// 13: load page-fault, 加载指令不能翻译它的虚拟地址</span></span><br><span class="line">        <span class="comment">// 15: store page-fault, 存储指令不能翻译它的虚拟地址</span></span><br><span class="line">        <span class="comment">// 12: instruction page-fault, PC 上的地址不能翻译</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">pgfault</span>(<span class="built_in">PGROUNDDOWN</span>(<span class="built_in">r_stval</span>())) == <span class="number">-1</span>)    p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, <span class="built_in">r_scause</span>(), p-&gt;pid);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, <span class="built_in">r_sepc</span>(), <span class="built_in">r_stval</span>());</span><br><span class="line">        p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="写在最后">写在最后</h2>
<p>耗时 25h35m</p>

    </article>
    <!-- license -->
        <div class="license-wrapper">
            <p>Author：<a href="https://horbyn.github.io">Horbyn</a>
            <p>Link：<a href="https://horbyn.github.io/2022/04/21/xv6-10/">https://horbyn.github.io/2022/04/21/xv6-10/</a>
            <p>Publish date：<a href="https://horbyn.github.io/2022/04/21/xv6-10/">April 21st 2022, 2:02:33 pm</a>
            <p>Update date：<a href="https://horbyn.github.io/2022/04/21/xv6-10/">February 28th 2025, 11:27:31 pm</a>
            <p>License：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
                <div class="nextSlogan">Next Post</div>
                <a href="/2022/04/21/xv6-11/" title="⌈xv6-fall2021⌋ MIT 6.828 巡礼">
                    <div class="nextTitle">⌈xv6-fall2021⌋ MIT 6.828 巡礼</div>
                </a>
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/2022/04/17/xv6-9/" title="⌈xv6-fall2021⌋ lab 9：file system">
                    <div class="prevTitle">⌈xv6-fall2021⌋ lab 9：file system</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="mailto:horbyn@outlook.com" class="iconfont-archer email" title="email" ></a>
                <a href="https://github.com/horbyn" class="iconfont-archer github" target="_blank" title="github"></a>
                <span class="iconfont-archer wechat" title="wechat">
                    <img class="profile-qr" src="/assets/example_qr.jpg" />
                </span>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    <!-- 不蒜子  -->
        <div class="busuanzi-container">
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#about"><span class="toc-number">1.</span> <span class="toc-text">ABOUT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmap-hard"><span class="toc-number">2.</span> <span class="toc-text">Mmap (HARD)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%A6%81%E6%B1%82%E8%AF%91%E8%8A%82%E9%80%89"><span class="toc-number">2.1.</span> <span class="toc-text">实验要求（译）（节选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%8F%90%E7%A4%BA%E8%AF%91%E8%8A%82%E9%80%89"><span class="toc-number">2.2.</span> <span class="toc-text">实验提示（译）（节选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">2.3.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#solution"><span class="toc-number">2.4.</span> <span class="toc-text">Solution</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">3.</span> <span class="toc-text">写在最后</span></a></li></ol>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 24
        </div>
        <!-- search  -->
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">02/10</span>
            <a class="archive-post-title" href="/2025/02/10/hoo-8/">「从零到一」内置命令</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/07</span>
            <a class="archive-post-title" href="/2025/02/07/hoo-7/">「从零到一」文件系统</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2025/02/05/hoo-6/">「从零到一」设备驱动</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/04</span>
            <a class="archive-post-title" href="/2025/02/04/hoo-5/">「从零到一」调度机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/01</span>
            <a class="archive-post-title" href="/2025/02/01/hoo-4/">「从零到一」中断机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span>
            <a class="archive-post-title" href="/2025/01/30/hoo-3/">「从零到一」内存管理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/07</span>
            <a class="archive-post-title" href="/2025/01/07/hoo-2/">「从零到一」内核引导与加载</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/02</span>
            <a class="archive-post-title" href="/2025/01/02/hoo-1/">「从零到一」实现一个 x86 的内核</a>
        </li>
                </ul>
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2023/11/01/live-1/">ARM 模拟 x86 环境不能直接使用 gdb 调试的解决方案</a>
        </li>
                </ul>
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/2022/05/28/trans-2/">x86 AT&T 汇编快速入门（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-11/">⌈xv6-fall2021⌋ MIT 6.828 巡礼</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-10/">⌈xv6-fall2021⌋ lab 10：mmap</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span>
            <a class="archive-post-title" href="/2022/04/17/xv6-9/">⌈xv6-fall2021⌋ lab 9：file system</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2022/04/15/xv6-8/">⌈xv6-fall2021⌋ lab 8：locks</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2022/04/11/xv6-7/">⌈xv6-fall2021⌋ lab 7：networking</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/2022/04/05/xv6-6/">⌈xv6-fall2021⌋ lab 6：Multithreading</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span>
            <a class="archive-post-title" href="/2022/04/04/xv6-5/">⌈xv6-fall2021⌋ lab 5：COW</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/trans-1/">RISC-V 调用约定（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/xv6-4/">⌈xv6-fall2021⌋ lab 4：Traps</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/25</span>
            <a class="archive-post-title" href="/2022/03/25/xv6-3/">⌈xv6-fall2021⌋ lab 3：Page tables</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2022/03/16/xv6-2/">⌈xv6-fall2021⌋ lab 2：System calls</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/14</span>
            <a class="archive-post-title" href="/2022/03/14/winsock/">Winsock 实现一个端到端通信软件</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2022/02/28/xv6-1/">⌈xv6-fall2021⌋ lab 1：Xv6 and Unix utilities</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span>
            <a class="archive-post-title" href="/2022/02/25/xv6-0/">⌈xv6-fall2021⌋ MIT 6.828 环境配置</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="hoo">
                <span class="iconfont-archer">&#xe606;</span>
                hoo
            </span>
            <span class="sidebar-tag-name" data-tags="translation">
                <span class="iconfont-archer">&#xe606;</span>
                translation
            </span>
            <span class="sidebar-tag-name" data-tags="winsock">
                <span class="iconfont-archer">&#xe606;</span>
                winsock
            </span>
            <span class="sidebar-tag-name" data-tags="xv6">
                <span class="iconfont-archer">&#xe606;</span>
                xv6
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
        <span class="sidebar-category-name" data-categories="KERNEL">
            <span class="iconfont-archer">&#xe60a;</span>
            KERNEL
        </span>
        <span class="sidebar-category-name" data-categories="LIVEHOOD">
            <span class="iconfont-archer">&#xe60a;</span>
            LIVEHOOD
        </span>
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://horbyn.github.io",
        root: siteMetaRoot,
        author: "Horbyn"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- main func -->
        <script src="/scripts/main.js"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js" onload="window.Fancybox.bind('[data-fancybox]')" defer></script>
        <!-- algolia -->
        <!-- busuanzi -->
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        <!-- async load share.js -->
            <script src="/scripts/share.js" async></script>
        <!-- mermaid -->
    </body>
</html>
