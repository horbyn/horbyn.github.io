<!DOCTYPE html>
<html lang="en">
    <!-- title -->
<!-- keywords -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="Horbyn">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Horbyn">
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    <meta name="description" content="">
    <meta name="description" content="介绍了如何使用 libbpf-bootstrap 工具快速创建一个 CO-RE（Compile Once, Run Everywhere） eBPF 项目。通过分析 libbpf-bootstrap CMake 文件，分析其是如何自动生成所需的 eBPF 项目结构，包括必要的源代码文件、编译配置和依赖项。并列举一个例子，阐述如何利用该工具创建支持 CO-RE 的 eBPF 程序，以便在不同版本的内">
<meta property="og:type" content="article">
<meta property="og:title" content="通过 libbpf-bootstrap 创建 CO-RE eBPF 项目">
<meta property="og:url" content="https://horbyn.github.io/2025/06/14/ebpf-1/">
<meta property="og:site_name">
<meta property="og:description" content="介绍了如何使用 libbpf-bootstrap 工具快速创建一个 CO-RE（Compile Once, Run Everywhere） eBPF 项目。通过分析 libbpf-bootstrap CMake 文件，分析其是如何自动生成所需的 eBPF 项目结构，包括必要的源代码文件、编译配置和依赖项。并列举一个例子，阐述如何利用该工具创建支持 CO-RE 的 eBPF 程序，以便在不同版本的内">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-06-14T10:10:40.000Z">
<meta property="article:modified_time" content="2025-06-14T10:20:12.286Z">
<meta property="article:author" content="Horbyn">
<meta property="article:tag" content="eBPF">
<meta name="twitter:card" content="summary">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/avatar/link.PNG">
    <title>通过 libbpf-bootstrap 创建 CO-RE eBPF 项目 · HorbynzZ</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .footer-fixed-btn,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(
            -45deg,
            #444 0,
            #444 80px,
            #333 80px,
            #333 160px
        );
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link id="stylesheet-fancybox" rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-base" rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link id="stylesheet-mobile" rel="preload" href="/css/mobile.css" as="style" onload="this.onload=null;this.rel='stylesheet';this.media='screen and (max-width: 960px)'">
    <link id="stylesheet-theme-dark" rel="preload" href="/css/dark.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    <!-- 百度统计  -->
    <!-- 谷歌统计  -->
    <!-- Google tag (gtag.js) -->
<meta name="generator" content="Hexo 6.0.0"></head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
        <body class="post-body">
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        <div class="header-sidebar-menu">
            <div style="padding-left: 1px;">&#xe775;</div>
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href="/">Horbynz hub</a>
        </span>
    </div>
    <!-- toggle banner -->
    <div class="banner">
        <div class="blog-title header-element">
            <a href="/">Horbynz hub</a>
        </div>
        <div class="post-title header-element">
            <a href="#" class="post-name">通过 libbpf-bootstrap 创建 CO-RE eBPF 项目</a>
        </div>
    </div>
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- donate button -->

    <!-- back to top button -->
    <div class="footer-fixed-btn footer-fixed-btn--hidden back-top">
        <div>&#xe639;</div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="    height:50vh;
">
    <!-- 主页  -->
    <!-- 404页  -->
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.png)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
                通过 libbpf-bootstrap 创建 CO-RE eBPF 项目
            <!-- 404 -->
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            <!-- 404 -->
        </p>
        <!-- 文章页 meta -->
            <div class="post-intros">
                <!-- 文章页标签  -->
                    <div class="post-intro-tags" >
        <a class="post-tag" href="javascript:void(0);" data-tags="eBPF">eBPF</a>
</div>

                <!-- 文章字数统计 -->
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">3.8k</span>Reading time: <span class="post-count reading-time">20 min</span></span>
                    </div>
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2025/06/14</span>
                    <!-- busuanzi -->
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" alt="loading">
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="环境">环境</h1>
<p>参考 <a
target="_blank" rel="noopener" href="https://github.com/libbpf/libbpf-bootstrap?tab=readme-ov-file#install-dependencies">libbpf-bootstrap
安装依赖</a> 和 <a
target="_blank" rel="noopener" href="https://github.com/libbpf/libbpf-bootstrap/issues/340">LLVM
版本问题</a>，以 ubuntu 为例，由于官方测试过 llvm-11 至
llvm-20，因此至少需要 ubuntu:jammy 以上。依赖如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install clang libelf1 libelf-dev zlib1g-dev</span><br></pre></td></tr></table></figure>
<p>下面是根据这些依赖创建的 C/C++ 环境容器镜像：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:noble</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁止交互式时区设置参考：https://serverfault.com/a/1016972</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># x86_64 或 aarch64</span></span><br><span class="line"><span class="keyword">ARG</span> ARCH</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置语言</span></span><br><span class="line"><span class="keyword">ENV</span> LC_ALL=en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE=en_US.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt install -y --no-install-recommends ca-certificates &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.bak &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;aarch64&quot;</span> ]; <span class="keyword">then</span> \</span></span><br><span class="line"><span class="language-bash">        sed -i <span class="string">&#x27;s@//ports.ubuntu.com@//mirrors.ustc.edu.cn@g&#x27;</span> /etc/apt/sources.list.d/ubuntu.sources; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span> \</span></span><br><span class="line"><span class="language-bash">        sed -i <span class="string">&#x27;s@//.*archive.ubuntu.com@//mirrors.ustc.edu.cn@g&#x27;</span> /etc/apt/sources.list.d/ubuntu.sources; \</span></span><br><span class="line"><span class="language-bash">        sed -i <span class="string">&#x27;s/security.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list.d/ubuntu.sources; \</span></span><br><span class="line"><span class="language-bash">        sed -i <span class="string">&#x27;s/http:/https:/g&#x27;</span> /etc/apt/sources.list.d/ubuntu.sources; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">else</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="built_in">echo</span> <span class="string">&quot;未知架构，无法设置 apt 代理&quot;</span>; \</span></span><br><span class="line"><span class="language-bash">        <span class="built_in">exit</span> 1; \</span></span><br><span class="line"><span class="language-bash">    <span class="keyword">fi</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        build-essential make gdb sudo vim wget git cmake \</span></span><br><span class="line"><span class="language-bash">        pkg-config clang libelf1 libelf-dev zlib1g-dev \</span></span><br><span class="line"><span class="language-bash">        systemd init plocate language-pack-en tree zsh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/* &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="comment"># 中文</span></span></span><br><span class="line">    sed -i -e <span class="string">&#x27;s/# zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/&#x27;</span> /etc/locale.gen &amp;&amp; \</span><br><span class="line">    dpkg-reconfigure --frontend=noninteractive locales &amp;&amp; \</span><br><span class="line">    <span class="comment"># 安装 zsh</span></span><br><span class="line">    git clone https://github.com/ohmyzsh/ohmyzsh.git /root/.oh-my-zsh &amp;&amp; \</span><br><span class="line">    cp /root/.oh-my-zsh/templates/zshrc.zsh-template /root/.zshrc &amp;&amp; \</span><br><span class="line">    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/plugins/zsh-syntax-highlighting &amp;&amp; \</span><br><span class="line">    git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/plugins/zsh-autosuggestions &amp;&amp; \</span><br><span class="line">    chsh -s $(which zsh) &amp;&amp; \</span><br><span class="line">    sed -i <span class="string">&#x27;s/^plugins=(git)$/plugins=(git wd zsh-syntax-highlighting zsh-autosuggestions)/&#x27;</span> ~/.zshrc &amp;&amp; \</span><br><span class="line">    <span class="comment"># 创建调试版 gdb</span></span><br><span class="line">    printf <span class="string">&#x27;#!/bin/bash\n\nsudo /usr/bin/gdb $@&#x27;</span> &gt; /usr/bin/gdb_sudo &amp;&amp; \</span><br><span class="line">    chmod +x /usr/bin/gdb_sudo &amp;&amp; \</span><br><span class="line">    <span class="comment"># mac 全局忽略 .DS_Store 配置文件</span></span><br><span class="line">    <span class="comment"># ref to: https://orianna-zzo.github.io/sci-tech/2018-01/mac%E4%B8%ADgit%E5%BF%BD%E7%95%A5.ds_store%E6%96%87%E4%BB%B6/</span></span><br><span class="line">    echo <span class="string">&quot;# Mac OS specified&quot;</span> &gt; ~/.gitignore_global &amp;&amp; \</span><br><span class="line">    echo <span class="string">&quot;**/.DS_Store&quot;</span> &gt; ~/.gitignore_global &amp;&amp; \</span><br><span class="line">    git config --global core.excludesfile ~/.gitignore_global</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/sbin/init&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>入口设置为 <code>/sbin/init</code> 以及安装 <code>systemd</code> 和
<code>ini</code> 的原因是，这样创建的容器才能运行 <code>systemctl</code>
命令</p>
<p>创建镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">x86 环境</span></span><br><span class="line">docker buildx build --load --platform linux/amd64 --build-arg ARCH=x86_64 -t ebpf:latest D:\Dockerfile_dirs\ebpf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">arm 环境</span></span><br><span class="line">docker buildx build --load --platform linux/arm64 --build-arg ARCH=aarch64 -t ebpf:latest /Users/horbyn/dockerfile.d/ebpf</span><br></pre></td></tr></table></figure>
<p>创建容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">x86 环境</span></span><br><span class="line">docker run -it -d --privileged --platform linux/amd64 --name ebpf -v D:\Repositories\my-project:/my-project -w /my-project ebpf:latest /sbin/init</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">arm 环境</span></span><br><span class="line">docker run -it -d --privileged --platform linux/amd64 --name ebpf -v /Users/horbyn/repositories/my-project:/my-project -w /my-project ebpf:latest /sbin/init</span><br></pre></td></tr></table></figure>
<p>运行容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it ebpf /bin/bash</span><br></pre></td></tr></table></figure>
<p>如果你的 eBPF 项目会调用 <code>bpf_printk()</code> 那么就需要挂载内核
debug 文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">挂载</span></span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"># </span><span class="language-bash">查看</span></span><br><span class="line">mount | grep debugfs</span><br></pre></td></tr></table></figure>
<h1 id="bootstrap-是怎么编译-ebpf-程序的">bootstrap 是怎么编译 eBPF
程序的</h1>
<p>可以通过 CMake 配置阶段展开的命令来分析：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">克隆 libbpf-bootstrap 项目</span></span><br><span class="line">git clone https://github.com/libbpf/libbpf-bootstrap</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">cmake -S examples/c -B build --trace-expand 2&amp;&gt; cmake.log</span><br></pre></td></tr></table></figure>
<p><code>--trace-expand</code> 参数会展开 CMake
执行的命令，并重定向输出到 cmake.log 文件中</p>
<h2 id="引入外部项目">引入外部项目</h2>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ExternalProject_Add(libbpf</span><br><span class="line">  PREFIX libbpf</span><br><span class="line">  ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ExternalProject_Add(bpftool</span><br><span class="line">  PREFIX bpftool</span><br><span class="line">  ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>用 <code>ExternalProject_add()</code> 引入外部项目，并在此阶段通过
<code>add_custom_command()</code> 导出了 <code>libbpf-build</code> 和
<code>bpftool-build</code> 两个 target</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">cmake.log 节选</span></span><br><span class="line">/usr/share/cmake-3.28/Modules/ExternalProject.cmake(2238):  add_custom_target(libbpf-build DEPENDS /my-project/libbpf-bootstrap/build/libbpf/src/libbpf-stamp/libbpf-build )</span><br><span class="line">/usr/share/cmake-3.28/Modules/ExternalProject.cmake(2238):  add_custom_target(bpftool-build DEPENDS /my-project/libbpf-bootstrap/build/bpftool/src/bpftool-stamp/bpftool-build )</span><br></pre></td></tr></table></figure>
<h2 id="导出变量">导出变量</h2>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(BPFOBJECT_BPFTOOL_EXE <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/bpftool/bootstrap/bpftool)</span><br><span class="line"><span class="keyword">set</span>(BPFOBJECT_VMLINUX_H <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/../../vmlinux.h/<span class="keyword">include</span>/<span class="variable">$&#123;ARCH&#125;</span>/vmlinux.h)</span><br><span class="line"><span class="keyword">set</span>(LIBBPF_INCLUDE_DIRS <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/libbpf)</span><br><span class="line"><span class="keyword">set</span>(LIBBPF_LIBRARIES <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/libbpf/libbpf.a)</span><br></pre></td></tr></table></figure>
<p>这些变量展开之后，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># </span><span class="language-bash">cmake.log 节选</span></span><br><span class="line">/my-project/libbpf-bootstrap/examples/c/CMakeLists.txt(70):  set(BPFOBJECT_BPFTOOL_EXE /my-project/libbpf-bootstrap/build/bpftool/bootstrap/bpftool )</span><br><span class="line">/my-project/libbpf-bootstrap/examples/c/CMakeLists.txt(71):  set(BPFOBJECT_VMLINUX_H /my-project/libbpf-bootstrap/examples/c/../../vmlinux.h/include/x86/vmlinux.h )</span><br><span class="line">/my-project/libbpf-bootstrap/examples/c/CMakeLists.txt(72):  set(LIBBPF_INCLUDE_DIRS /my-project/libbpf-bootstrap/build/libbpf )</span><br><span class="line">/my-project/libbpf-bootstrap/examples/c/CMakeLists.txt(73):  set(LIBBPF_LIBRARIES /my-project/libbpf-bootstrap/build/libbpf/libbpf.a )</span><br></pre></td></tr></table></figure>
<p>这些变量会在 <code>bpf_object()</code>
宏定义中被使用，而这个宏是通过下面两个 cmake 命令被引入：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/../../tools/cmake)</span><br><span class="line"><span class="keyword">find_package</span>(BpfObject REQUIRED)</span><br></pre></td></tr></table></figure>
<p>这个宏定义会完成最终的编译 eBPF 用户态和内核态程序的工作</p>
<h2 id="编译-ebpf-程序">编译 eBPF 程序</h2>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">file</span>(GLOB apps *.bpf.c)</span><br><span class="line"><span class="keyword">foreach</span>(app <span class="variable">$&#123;apps&#125;</span>)</span><br><span class="line">  <span class="keyword">get_filename_component</span>(app_stem <span class="variable">$&#123;app&#125;</span> NAME_WE)</span><br><span class="line"></span><br><span class="line">  bpf_object(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>.bpf.c)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">add_dependencies</span>(<span class="variable">$&#123;app_stem&#125;</span>_skel libbpf-build bpftool-build)</span><br><span class="line">  <span class="keyword">add_executable</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>.c)</span><br><span class="line">  <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>_skel)</span><br><span class="line"><span class="keyword">endforeach</span>()</span><br></pre></td></tr></table></figure>
<p>先通过 <code>file()</code> 找到所有的 <code>bpf.c</code>
后缀的文件，然后调用 <code>bpf_object()</code> 宏：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FindBpfObject.cmake 节选</span></span><br><span class="line"><span class="keyword">macro</span>(bpf_object name input)</span><br><span class="line">  <span class="keyword">set</span>(BPF_C_FILE <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="variable">$&#123;input&#125;</span>)</span><br><span class="line">  <span class="keyword">set</span>(BPF_O_FILE <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>.bpf.o)</span><br><span class="line">  <span class="keyword">set</span>(BPF_SKEL_FILE <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>.skel.h)</span><br><span class="line">  <span class="keyword">set</span>(OUTPUT_TARGET <span class="variable">$&#123;name&#125;</span>_skel)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">add_custom_command</span>(OUTPUT <span class="variable">$&#123;BPF_O_FILE&#125;</span></span><br><span class="line">    <span class="keyword">COMMAND</span> <span class="variable">$&#123;BPFOBJECT_CLANG_EXE&#125;</span> -g -O2 -<span class="keyword">target</span> bpf -D__TARGET_ARCH_<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">            <span class="variable">$&#123;CLANG_SYSTEM_INCLUDES&#125;</span> -I<span class="variable">$&#123;GENERATED_VMLINUX_DIR&#125;</span></span><br><span class="line">            -isystem <span class="variable">$&#123;LIBBPF_INCLUDE_DIRS&#125;</span> -c <span class="variable">$&#123;BPF_C_FILE&#125;</span> -o <span class="variable">$&#123;BPF_O_FILE&#125;</span></span><br><span class="line">    DEPENDS <span class="variable">$&#123;BPF_C_FILE&#125;</span> <span class="variable">$&#123;BPF_H_FILES&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">add_custom_command</span>(OUTPUT <span class="variable">$&#123;BPF_SKEL_FILE&#125;</span></span><br><span class="line">    <span class="keyword">COMMAND</span> bash -c <span class="string">&quot;$&#123;BPFOBJECT_BPFTOOL_EXE&#125; gen skeleton $&#123;BPF_O_FILE&#125; &gt; $&#123;BPF_SKEL_FILE&#125;&quot;</span></span><br><span class="line">    DEPENDS <span class="variable">$&#123;BPF_O_FILE&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">add_library</span>(<span class="variable">$&#123;OUTPUT_TARGET&#125;</span> INTERFACE)</span><br><span class="line">  <span class="keyword">target_sources</span>(<span class="variable">$&#123;OUTPUT_TARGET&#125;</span> INTERFACE <span class="variable">$&#123;BPF_SKEL_FILE&#125;</span>)</span><br><span class="line">  <span class="keyword">target_include_directories</span>(<span class="variable">$&#123;OUTPUT_TARGET&#125;</span> INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>)</span><br><span class="line">  <span class="keyword">target_include_directories</span>(<span class="variable">$&#123;OUTPUT_TARGET&#125;</span> SYSTEM INTERFACE <span class="variable">$&#123;LIBBPF_INCLUDE_DIRS&#125;</span>)</span><br><span class="line">  <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;OUTPUT_TARGET&#125;</span> INTERFACE <span class="variable">$&#123;LIBBPF_LIBRARIES&#125;</span> -lelf -lz)</span><br><span class="line"><span class="keyword">endmacro</span>()</span><br></pre></td></tr></table></figure>
<p>这个宏中先是定义了一些内部使用的 cmake 变量：</p>
<ul>
<li><code>BPF_C_FILE</code>：<code>bpf.c</code> 文件，也即 eBPF
内核态文件，如 <code>bootstrap.bpf.c</code></li>
<li><code>BPF_O_FILE</code>：内核态文件对应的二进制文件，如
<code>bootstrap.bpf.o</code></li>
<li><code>BPF_SKEL_FILE</code>：bpftool 生成的可供 eBPF
用户态程序调用的接口（接口内封装了内核态功能），如
<code>bootstrap.skel.h</code></li>
<li><code>OUTPUT_TARGET</code>：导出给外部使用的 target 的名字，如
<code>bootstrap_skel</code></li>
</ul>
<p>第一个 <code>add_custom_command</code> 是调用 <code>clang</code> 编译
<code>bpf.c</code> 文件，生成内核态文件 <code>bootstrap.bpf.o</code>
的过程，这个过程会引用外部定义的 <code>libbpf</code> 头文件的位置，即
<code>LIBBPF_INCLUDE_DIRS</code> 变量</p>
<p>第二个 <code>add_custom_command</code> 是调用 <code>bpftool</code>
生成 <code>bootstrap.skel.h</code> 的过程，这个过程会引用外部定义的
<code>bpftool</code> 工具的位置，即 <code>BPFOBJECT_BPFTOOL_EXE</code>
变量</p>
<p>最后就是 <code>add_library()</code> 导出一个
target，<code>target_sources()</code> 将源文件与 target
关联起来，使其他依赖于这个 target
的也会包含这个源文件，<code>target_include_directories()</code> 来指定
target 的头文件搜索路径，<code>target_link_libraries()</code> 指定
target 要链接的库</p>
<p>整理一下这个过程，也即是将内核态文件编译为 <code>bpf.o</code>
的二进制，进而通过 <code>bpftool</code> 生成
<code>skel.h</code>，这便是用户态可调用的 "内核态" 接口，最终将
<code>skel.h</code> 与导出的 <code>bootstrap_skel</code> 关联起来</p>
<p>最后的三行 cmake 调用则是常规的用户态程序的编译，这里要注意
<code>add_dependencies()</code> 的两个依赖 <code>libbpf-build</code> 和
<code>bpftool-build</code> 是在前面 <code>ExternalProject_Add()</code>
过程中生成的，如果你不想用
<code>ExternalProject_Add()</code>，就需要自己通过
<code>add_custom_command()</code> 导出这两个 target：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_dependencies</span>(<span class="variable">$&#123;app_stem&#125;</span>_skel libbpf-build bpftool-build)</span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>.c)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>_skel)</span><br></pre></td></tr></table></figure>
<p>换句话来说，通过 <code>bpf_object()</code> 宏最终将内核态程序导出到
<code>_skel</code> 后缀的 target 中，最后只需要在编译内核态程序后将这个
target 链接进去就完成了一个 CO-RE eBPF 程序的编译（CO-RE
简单来说就是开发环境编译出来的 eBPF
程序，在迁移到执行环境中运行时，不需要理会 eBPF
程序执行时的依赖，如内核版本、内核头文件等等，更多内容可以参考 <a
target="_blank" rel="noopener" href="https://arthurchiao.art/blog/bpf-portability-and-co-re-zh/">[译]
BPF 可移植性和 CO-RE（一次编译，到处运行）</a>）</p>
<h1 id="创建一个-co-re-的-ebpf-项目">创建一个 CO-RE 的 eBPF 项目</h1>
<p>现在从零开始，假设刚执行完 <code>git init</code>，那么创建一个 CO-RE
项目，第一步便是引入 <code>libbpf-bootstrap</code>，这里就不讨论
<code>FetchContent_Declare()</code> 和 <code>git submodule</code>
引入第三方库的优劣，直接用后者：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git submodule add https://github.com/libbpf/libbpf-bootstrap.git libs/libbpf-bootstrap</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>
<p>这里使用一个很简单的 eBPF 内核态程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.bpf.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmlinux.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_execve</span><span class="params">(<span class="keyword">struct</span> trace_event_raw_sys_enter *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> msg[] = <span class="string">&quot;Hello from eBPF! Process executed: &quot;</span>;</span><br><span class="line">  bpf_printk(<span class="string">&quot;%s&quot;</span>, msg);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>只要调用了 <code>execve</code> 系统调用，就会触发
<code>handle_execve</code>
函数，打印出一条消息。换句话说，<code>ls</code>、<code>cat</code>
等命令都会切换执行流，所以会触发这个 eBPF 程序</p>
<p>对应的用户态程序如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello.skel.h&quot;</span> <span class="comment">// 由 libbpf-bootstrap 自动生成</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">hello_bpf</span> *<span class="title">skel</span> =</span> hello_bpf__open();</span><br><span class="line">  <span class="keyword">if</span> (!skel)</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;Failed to open BPF skeleton&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hello_bpf__load(skel))</span><br><span class="line">  &#123; <span class="comment">// 加载并验证 BPF 程序</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to load BPF skeleton\n&quot;</span>);</span><br><span class="line">    hello_bpf__destroy(skel);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hello_bpf__attach(skel))</span><br><span class="line">  &#123; <span class="comment">// 附加到挂载点</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to attach BPF program\n&quot;</span>);</span><br><span class="line">    hello_bpf__destroy(skel);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;eBPF program running! Run `sudo cat /sys/kernel/debug/tracing/trace_pipe` to view logs.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">// 保持程序运行</span></span><br><span class="line"></span><br><span class="line">  hello_bpf__destroy(skel);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  /my-project git:(main) ✗ tree -a -L 1 .</span><br><span class="line">.</span><br><span class="line">├── .git</span><br><span class="line">├── .gitmodules</span><br><span class="line">├── hello.bpf.c</span><br><span class="line">├── hello.c</span><br><span class="line">└── libs</span><br><span class="line"></span><br><span class="line">3 directories, 3 files</span><br></pre></td></tr></table></figure>
<p>使用的 CMakeLists.txt 如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/libs/libbpf-bootstrap/tools/cmake)</span><br><span class="line"><span class="keyword">set</span>(LIBBPF_BOOTSTRAP_PATH <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/libs/libbpf-bootstrap)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(ExternalProject)</span><br><span class="line">ExternalProject_Add(libbpf</span><br><span class="line">  PREFIX libbpf</span><br><span class="line">  SOURCE_DIR <span class="variable">$&#123;LIBBPF_BOOTSTRAP_PATH&#125;</span>/libbpf/src</span><br><span class="line">  CONFIGURE_COMMAND <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">BUILD_COMMAND</span> make</span><br><span class="line">    BUILD_STATIC_ONLY=<span class="number">1</span></span><br><span class="line">    OBJDIR=<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/libbpf/libbpf</span><br><span class="line">    DESTDIR=<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/libbpf</span><br><span class="line">    INCLUDEDIR=</span><br><span class="line">    LIBDIR=</span><br><span class="line">    UAPIDIR=</span><br><span class="line">    <span class="keyword">install</span> install_uapi_headers</span><br><span class="line">  BUILD_IN_SOURCE <span class="keyword">TRUE</span></span><br><span class="line">  INSTALL_COMMAND <span class="string">&quot;&quot;</span></span><br><span class="line">  STEP_TARGETS build</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ExternalProject_Add(bpftool</span><br><span class="line">  PREFIX bpftool</span><br><span class="line">  SOURCE_DIR <span class="variable">$&#123;LIBBPF_BOOTSTRAP_PATH&#125;</span>/bpftool/src</span><br><span class="line">  CONFIGURE_COMMAND <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">BUILD_COMMAND</span> make bootstrap</span><br><span class="line">    OUTPUT=<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/bpftool/</span><br><span class="line">  BUILD_IN_SOURCE <span class="keyword">TRUE</span></span><br><span class="line">  INSTALL_COMMAND <span class="string">&quot;&quot;</span></span><br><span class="line">  STEP_TARGETS build</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;x86_64&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;x86&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;arm&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;arm&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;aarch64&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;arm64&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;ppc64le&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;powerpc&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;mips&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;mips&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;riscv64&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;riscv&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span>(<span class="variable">$&#123;CMAKE_SYSTEM_PROCESSOR&#125;</span> <span class="keyword">MATCHES</span> <span class="string">&quot;loongarch64&quot;</span>)</span><br><span class="line">  <span class="keyword">set</span>(ARCH <span class="string">&quot;loongarch&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(BPFOBJECT_BPFTOOL_EXE <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/bpftool/bootstrap/bpftool)</span><br><span class="line"><span class="keyword">set</span>(BPFOBJECT_VMLINUX_H <span class="variable">$&#123;LIBBPF_BOOTSTRAP_PATH&#125;</span>/vmlinux.h/<span class="keyword">include</span>/<span class="variable">$&#123;ARCH&#125;</span>/vmlinux.h)</span><br><span class="line"><span class="keyword">set</span>(LIBBPF_INCLUDE_DIRS <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/libbpf)</span><br><span class="line"><span class="keyword">set</span>(LIBBPF_LIBRARIES <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/libbpf/libbpf.a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(BpfObject REQUIRED)</span><br><span class="line"><span class="keyword">file</span>(GLOB apps *.bpf.c)</span><br><span class="line"><span class="keyword">foreach</span>(app <span class="variable">$&#123;apps&#125;</span>)</span><br><span class="line">  <span class="keyword">get_filename_component</span>(app_stem <span class="variable">$&#123;app&#125;</span> NAME_WE)</span><br><span class="line"></span><br><span class="line">  bpf_object(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>.bpf.c)</span><br><span class="line">  <span class="keyword">add_dependencies</span>(<span class="variable">$&#123;app_stem&#125;</span>_skel libbpf-build bpftool-build)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">add_executable</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>.c)</span><br><span class="line">  <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;app_stem&#125;</span> <span class="variable">$&#123;app_stem&#125;</span>_skel)</span><br><span class="line"><span class="keyword">endforeach</span>()</span><br></pre></td></tr></table></figure>
<p>现在可以编译整个 eBPF 项目了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">➜  /my-project git:(main) ✗ cmake -S . -B build --trace-expand 2&amp;&gt; cmake.log</span><br><span class="line">Put cmake in trace mode, but with variables expanded.</span><br><span class="line">-- The C compiler identification is GNU 13.3.0</span><br><span class="line">-- The CXX compiler identification is GNU 13.3.0</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- Found clang version: 18.1.3 (1ubuntu1)</span><br><span class="line">-- Found BpfObject: /my-project/build/bpftool/bootstrap/bpftool  </span><br><span class="line">-- BPF system include flags: -idirafter;/usr/lib/llvm-18/lib/clang/18/include;-idirafter;/usr/local/include;-idirafter;/usr/include/x86_64-linux-gnu;-idirafter;/usr/include</span><br><span class="line">-- BPF target arch: x86</span><br><span class="line">-- Configuring done (1.5s)</span><br><span class="line">-- Generating done (0.2s)</span><br><span class="line">-- Build files have been written to: /my-project/build</span><br><span class="line"></span><br><span class="line">➜  /my-project git:(main) ✗ cmake --build build                             </span><br><span class="line">[  3%] Creating directories for &#x27;libbpf&#x27;</span><br><span class="line">[  6%] No download step for &#x27;libbpf&#x27;</span><br><span class="line">[  9%] No update step for &#x27;libbpf&#x27;</span><br><span class="line">[ 12%] No patch step for &#x27;libbpf&#x27;</span><br><span class="line">[ 15%] No configure step for &#x27;libbpf&#x27;</span><br><span class="line">[ 18%] Performing build step for &#x27;libbpf&#x27;</span><br><span class="line">  MKDIR    /my-project/build/libbpf/libbpf/staticobjs</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/bpf.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/btf.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/libbpf.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/libbpf_errno.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/netlink.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/nlattr.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/str_error.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/libbpf_probes.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/btf_dump.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/hashmap.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/ringbuf.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/strset.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/linker.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/gen_loader.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/relo_core.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/usdt.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/zip.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/elf.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/features.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/btf_iter.o</span><br><span class="line">  CC       /my-project/build/libbpf/libbpf/staticobjs/btf_relocate.o</span><br><span class="line">  AR       /my-project/build/libbpf/libbpf/libbpf.a</span><br><span class="line">  INSTALL  bpf.h libbpf.h btf.h libbpf_common.h libbpf_legacy.h bpf_helpers.h bpf_helper_defs.h bpf_tracing.h bpf_endian.h bpf_core_read.h skel_internal.h libbpf_version.h usdt.bpf.h</span><br><span class="line">  INSTALL  /my-project/build/libbpf/libbpf/libbpf.pc</span><br><span class="line">  INSTALL  /my-project/build/libbpf/libbpf/libbpf.a </span><br><span class="line">  INSTALL  ../include/uapi/linux/bpf.h ../include/uapi/linux/bpf_common.h ../include/uapi/linux/btf.h</span><br><span class="line">[ 21%] No install step for &#x27;libbpf&#x27;</span><br><span class="line">[ 25%] Completed &#x27;libbpf&#x27;</span><br><span class="line">[ 25%] Built target libbpf</span><br><span class="line">[ 28%] Creating directories for &#x27;bpftool&#x27;</span><br><span class="line">[ 31%] No download step for &#x27;bpftool&#x27;</span><br><span class="line">[ 34%] No update step for &#x27;bpftool&#x27;</span><br><span class="line">[ 37%] No patch step for &#x27;bpftool&#x27;</span><br><span class="line">[ 40%] No configure step for &#x27;bpftool&#x27;</span><br><span class="line">[ 43%] Performing build step for &#x27;bpftool&#x27;</span><br><span class="line">...                        libbfd: [ OFF ]</span><br><span class="line">...               clang-bpf-co-re: [ on  ]</span><br><span class="line">...                          llvm: [ OFF ]</span><br><span class="line">...                        libcap: [ OFF ]</span><br><span class="line">  MKDIR    /my-project/build/bpftool/bootstrap/libbpf/staticobjs</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/bpf.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/btf.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/libbpf.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/libbpf_errno.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/netlink.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/nlattr.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/str_error.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/libbpf_probes.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/bpf_prog_linfo.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/btf_dump.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/hashmap.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/ringbuf.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/strset.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/linker.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/gen_loader.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/relo_core.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/usdt.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/zip.o</span><br><span class="line">  CC       /my-project/build/bpftool/bootstrap/libbpf/staticobjs/elf.o</span><br><span class="line">  AR       /my-project/build/bpftool/bootstrap/libbpf/libbpf.a</span><br><span class="line">  INSTALL  bpf.h libbpf.h btf.h libbpf_common.h libbpf_legacy.h bpf_helpers.h bpf_helper_defs.h bpf_tracing.h bpf_endian.h bpf_core_read.h skel_internal.h libbpf_version.h usdt.bpf.h</span><br><span class="line">[ 46%] No install step for &#x27;bpftool&#x27;</span><br><span class="line">[ 50%] Completed &#x27;bpftool&#x27;</span><br><span class="line">[ 50%] Built target bpftool</span><br><span class="line">[ 68%] Built target bpftool-build</span><br><span class="line">[ 87%] Built target libbpf-build</span><br><span class="line">[ 90%] [clang] Building BPF object: hello</span><br><span class="line">[ 93%] [skel]  Building BPF skeleton: hello</span><br><span class="line">[ 96%] Building C object CMakeFiles/hello.dir/hello.c.o</span><br><span class="line"><span class="meta">[100%</span><span class="language-bash">] Linking C executable hello</span></span><br><span class="line"><span class="meta">[100%</span><span class="language-bash">] Built target hello</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是在执行 <code>ExternalProject_Add()</code> 过程中支持
<code>cmake -j 8</code> 这种并行编译，详见 <a
target="_blank" rel="noopener" href="https://discourse.cmake.org/t/external-project-does-not-use-parallel-jobs/3359">External
project does not use parallel jobs</a></p>
<p>然后挂载 debug 文件系统，就可以运行这个 eBPF 程序了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">➜  /my-project git:(main) ✗ build/hello</span><br><span class="line">eBPF program running! Run `sudo cat /sys/kernel/debug/tracing/trace_pipe` to view logs.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在另一个终端中运行
<code>sudo cat /sys/kernel/debug/tracing/trace_pipe</code> 就可以看到
eBPF 程序的输出了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">➜  /my-project git:(main) ✗ sudo cat /sys/kernel/debug/tracing/trace_pipe</span><br><span class="line">              ls-341634  [010] ...21 22722.835020: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">              ls-341636  [004] ...21 22722.835088: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">            expr-341637  [002] ...21 22722.836163: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">            expr-341638  [009] ...21 22722.836296: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">           sleep-341639  [010] ...21 22722.836981: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">           sleep-341640  [004] ...21 22722.837055: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">       systemctl-341641  [002] ...21 22722.843927: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">       systemctl-341641  [002] ...21 22722.843962: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">       systemctl-341642  [010] ...21 22723.097366: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">       systemctl-341642  [010] ...21 22723.097378: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">             sed-341643  [008] ...21 22723.109197: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">             cat-341644  [003] ...21 22723.110647: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">              sh-341646  [004] ...21 22723.193747: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">           which-341647  [010] ...21 22723.194626: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">              sh-341648  [003] ...21 22723.197012: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">              ps-341649  [010] ...21 22723.197964: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">              sh-341650  [005] ...21 22723.202623: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">     cpuUsage.sh-341651  [007] ...21 22723.203390: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">             sed-341652  [008] ...21 22723.204677: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">             cat-341653  [010] ...21 22723.206450: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">           sleep-341654  [002] ...21 22723.207342: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">          bridge-341655  [011] ...21 22723.288592: bpf_trace_printk: Hello from eBPF! Process executed: </span><br><span class="line">         portmap-341661  [008] ...21 22723.290862: bpf_trace_printk: Hello from eBPF! Process executed:</span><br></pre></td></tr></table></figure>

    </article>
    <!-- license -->
        <div class="license-wrapper">
            <p>Author：<a href="https://horbyn.github.io">Horbyn</a>
            <p>Link：<a href="https://horbyn.github.io/2025/06/14/ebpf-1/">https://horbyn.github.io/2025/06/14/ebpf-1/</a>
            <p>Publish date：<a href="https://horbyn.github.io/2025/06/14/ebpf-1/">June 14th 2025, 6:10:40 pm</a>
            <p>Update date：<a href="https://horbyn.github.io/2025/06/14/ebpf-1/">June 14th 2025, 6:20:12 pm</a>
            <p>License：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
        </li>
        <li class="previous">
                <div class="prevSlogan">Previous Post</div>
                <a href="/2025/03/02/github-index/" title="美化 Github 主页">
                    <div class="prevTitle">美化 Github 主页</div>
                </a>
        </li>
    </ul>
    <!-- comment -->
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->

            
            
            
            <!-- utteranc评论 -->

            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->

            
            
            
        </div>
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    <!-- Mathjax -->
</main>

                <!-- profile -->
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
        <div class="social">
                            <a href="mailto:horbyn@outlook.com" class="iconfont-archer email" title="email" ></a>
                <a href="https://github.com/horbyn" class="iconfont-archer github" target="_blank" title="github"></a>
                <span class="iconfont-archer wechat" title="wechat">
                    <img class="profile-qr" src="/assets/example_qr.jpg" />
                </span>

        </div>
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    <!-- 不蒜子  -->
        <div class="busuanzi-container">
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
        </div>
</footer>

        </div>
        <!-- toc -->
            <div class="toc-wrapper toc-wrapper-loding" style=    top:50vh;
>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bootstrap-%E6%98%AF%E6%80%8E%E4%B9%88%E7%BC%96%E8%AF%91-ebpf-%E7%A8%8B%E5%BA%8F%E7%9A%84"><span class="toc-number">2.</span> <span class="toc-text">bootstrap 是怎么编译 eBPF
程序的</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.1.</span> <span class="toc-text">引入外部项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.</span> <span class="toc-text">导出变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-ebpf-%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.3.</span> <span class="toc-text">编译 eBPF 程序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-co-re-%E7%9A%84-ebpf-%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.</span> <span class="toc-text">创建一个 CO-RE 的 eBPF 项目</span></a></li></ol>
            </div>
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    <div class="total-and-search">
        <div class="total-archive">
        Total : 28
        </div>
        <!-- search  -->
    </div>
    <div class="post-archive">
            <div class="archive-year"> 2025 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">06/14</span>
            <a class="archive-post-title" href="/2025/06/14/ebpf-1/">通过 libbpf-bootstrap 创建 CO-RE eBPF 项目</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span>
            <a class="archive-post-title" href="/2025/03/02/github-index/">美化 Github 主页</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/10</span>
            <a class="archive-post-title" href="/2025/02/10/hoo-8/">「从零到一」内置命令</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/07</span>
            <a class="archive-post-title" href="/2025/02/07/hoo-7/">「从零到一」文件系统</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/05</span>
            <a class="archive-post-title" href="/2025/02/05/hoo-6/">「从零到一」设备驱动</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/04</span>
            <a class="archive-post-title" href="/2025/02/04/hoo-5/">「从零到一」调度机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/01</span>
            <a class="archive-post-title" href="/2025/02/01/hoo-4/">「从零到一」中断机制</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span>
            <a class="archive-post-title" href="/2025/01/30/hoo-3/">「从零到一」内存管理</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/07</span>
            <a class="archive-post-title" href="/2025/01/07/hoo-2/">「从零到一」内核引导与加载</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">01/02</span>
            <a class="archive-post-title" href="/2025/01/02/hoo-1/">「从零到一」实现一个 x86 的内核</a>
        </li>
                </ul>
            <div class="archive-year"> 2024 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">10/23</span>
            <a class="archive-post-title" href="/2024/10/23/privilege/">关于 x86 特权级这种保护机制</a>
        </li>
                </ul>
            <div class="archive-year"> 2023 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">11/01</span>
            <a class="archive-post-title" href="/2023/11/01/live-1/">ARM 模拟 x86 环境不能直接使用 gdb 调试的解决方案</a>
        </li>
                </ul>
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
        <li class="archive-post-item">
            <span class="archive-post-date">05/28</span>
            <a class="archive-post-title" href="/2022/05/28/trans-2/">x86 AT&T 汇编快速入门（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-11/">⌈xv6-fall2021⌋ MIT 6.828 巡礼</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/21</span>
            <a class="archive-post-title" href="/2022/04/21/xv6-10/">⌈xv6-fall2021⌋ lab 10：mmap</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span>
            <a class="archive-post-title" href="/2022/04/17/xv6-9/">⌈xv6-fall2021⌋ lab 9：file system</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/15</span>
            <a class="archive-post-title" href="/2022/04/15/xv6-8/">⌈xv6-fall2021⌋ lab 8：locks</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/11</span>
            <a class="archive-post-title" href="/2022/04/11/xv6-7/">⌈xv6-fall2021⌋ lab 7：networking</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/05</span>
            <a class="archive-post-title" href="/2022/04/05/xv6-6/">⌈xv6-fall2021⌋ lab 6：Multithreading</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">04/04</span>
            <a class="archive-post-title" href="/2022/04/04/xv6-5/">⌈xv6-fall2021⌋ lab 5：COW</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/trans-1/">RISC-V 调用约定（译文）</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/29</span>
            <a class="archive-post-title" href="/2022/03/29/xv6-4/">⌈xv6-fall2021⌋ lab 4：Traps</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/25</span>
            <a class="archive-post-title" href="/2022/03/25/xv6-3/">⌈xv6-fall2021⌋ lab 3：Page tables</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/16</span>
            <a class="archive-post-title" href="/2022/03/16/xv6-2/">⌈xv6-fall2021⌋ lab 2：System calls</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">03/14</span>
            <a class="archive-post-title" href="/2022/03/14/winsock/">Winsock 实现一个端到端通信软件</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span>
            <a class="archive-post-title" href="/2022/02/28/xv6-1/">⌈xv6-fall2021⌋ lab 1：Xv6 and Unix utilities</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span>
            <a class="archive-post-title" href="/2022/02/25/xv6-0/">⌈xv6-fall2021⌋ MIT 6.828 环境配置</a>
        </li>
        <li class="archive-post-item">
            <span class="archive-post-date">02/22</span>
            <a class="archive-post-title" href="/2022/02/22/hello-world/">Hello world</a>
        </li>
            </ul>
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
            <span class="sidebar-tag-name" data-tags="eBPF">
                <span class="iconfont-archer">&#xe606;</span>
                eBPF
            </span>
            <span class="sidebar-tag-name" data-tags="Blogs">
                <span class="iconfont-archer">&#xe606;</span>
                Blogs
            </span>
            <span class="sidebar-tag-name" data-tags="hoo">
                <span class="iconfont-archer">&#xe606;</span>
                hoo
            </span>
            <span class="sidebar-tag-name" data-tags="translation">
                <span class="iconfont-archer">&#xe606;</span>
                translation
            </span>
            <span class="sidebar-tag-name" data-tags="mit6.828">
                <span class="iconfont-archer">&#xe606;</span>
                mit6.828
            </span>
            <span class="sidebar-tag-name" data-tags="winsock">
                <span class="iconfont-archer">&#xe606;</span>
                winsock
            </span>
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
        <span class="sidebar-category-name" data-categories="KERNEL">
            <span class="iconfont-archer">&#xe60a;</span>
            KERNEL
        </span>
        <span class="sidebar-category-name" data-categories="LIVEHOOD">
            <span class="iconfont-archer">&#xe60a;</span>
            LIVEHOOD
        </span>
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://horbyn.github.io",
        root: siteMetaRoot,
        author: "Horbyn"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->

        <!-- main func -->
        <script src="/scripts/main.js"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.36/dist/fancybox/fancybox.umd.js" onload="window.Fancybox.bind('[data-fancybox]')" defer></script>
        <!-- algolia -->
        <!-- busuanzi -->
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        <!-- async load share.js -->
            <script src="/scripts/share.js" async></script>
        <!-- mermaid -->
    </body>
</html>
